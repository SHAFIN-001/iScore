<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - iScore</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/theme.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</head>
<body>
    <div class="auth-container">
        <div class="auth-card register-card">
            <div class="auth-header">
                <button id="theme-toggle" class="theme-toggle-btn" aria-label="Toggle Theme">
                    <div class="theme-icons">
                        <span class="theme-icon light material-symbols-outlined">light_mode</span>
                        <span class="theme-icon dark material-symbols-outlined">dark_mode</span>
                    </div>
                </button>
                <div class="logo-section">
                    <div class="logo">I</div>
                    <h1>iScore</h1>
                </div>
                <h2>Create Account</h2>
                <p>Join iScore and start your journey</p>
            </div>

            <form id="registerForm" class="auth-form multi-step">
                <!-- Step 1: Basic Information -->
                <div class="step active" id="step1">
                    <h3>Basic Information</h3>

                    <div class="form-group">
                        <label for="role">I am a</label>
                        <select id="role" name="role" required>
                            <option value="">Select your role</option>
                            <option value="student">Student</option>
                            <option value="tutor">Tutor</option>
                            <option value="parent">Parent</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="fullName">Full Name</label>
                        <div class="input-group">
                            <i class="fas fa-user"></i>
                            <input type="text" id="fullName" name="fullName" required placeholder="Enter your full name">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="nickName">Nick Name</label>
                        <div class="input-group">
                            <i class="fas fa-smile"></i>
                            <input type="text" id="nickName" name="nickName" placeholder="Enter your nick name">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="username">Username</label>
                        <div class="input-group">
                            <i class="fas fa-at"></i>
                            <input type="text" id="username" name="username" required placeholder="Choose a username">
                        </div>
                        <small class="form-hint">Username must be unique and 3-20 characters long</small>
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <div class="input-group">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="email" name="email" required placeholder="Enter your email">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <div class="input-group">
                            <i class="fas fa-phone"></i>
                            <input type="tel" id="phone" name="phone" required placeholder="Enter your phone number">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="dob">Date of Birth</label>
                        <div class="input-group">
                            <i class="fas fa-calendar"></i>
                            <input type="date" id="dob" name="dob" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select id="gender" name="gender" required>
                            <option value="">Select gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="profilePicture">Profile Picture (Optional)</label>
                        <div class="file-upload-container">
                            <input type="file" id="profilePicture" name="profilePicture" accept="image/*" class="file-input">
                            <label for="profilePicture" class="file-label">
                                <i class="fas fa-camera"></i>
                                <span>Choose profile picture</span>
                            </label>
                            <div class="image-preview" id="profilePreview" style="display: none;">
                                <img src="" alt="Profile preview">
                                <button type="button" class="remove-image" onclick="removeImage('profilePicture')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Role-specific Information -->
                <div class="step" id="step2">
                    <h3 id="step2Title">Role-specific Information</h3>

                    <!-- Student Specific Fields -->
                    <div id="studentFields" class="role-fields" style="display: none;">
                        <div class="form-group">
                            <label for="institution">Institution/School</label>
                            <div class="input-group">
                                <i class="fas fa-school"></i>
                                <input type="text" id="institution" name="institution" placeholder="Enter your school/college name">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="sscBatch">SSC Batch Year</label>
                            <div class="input-group">
                                <i class="fas fa-calendar"></i>
                                <select id="sscBatch" name="sscBatch">
                                    <option value="">Select SSC batch year</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="tutorsList">Select Your Tutors <span style="color: red;">*</span></label>
                            <div id="tutorsList" class="tutors-list">
                                <div class="loading-tutors">
                                    <i class="fas fa-spinner fa-spin"></i> Loading available tutors...
                                </div>
                            </div>
                            <small class="form-hint">You must select at least one tutor to continue</small>
                        </div>
                    </div>

                    <!-- Tutor Specific Fields -->
                    <div id="tutorFields" class="role-fields" style="display: none;">
                        <div class="form-group">
                            <label for="tutorInstitution">Institution/University</label>
                            <div class="input-group">
                                <i class="fas fa-university"></i>
                                <input type="text" id="tutorInstitution" name="tutorInstitution" placeholder="Your university/institution">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="mainSubject">Main Subject</label>
                            <div class="input-group">
                                <i class="fas fa-book"></i>
                                <input type="text" id="mainSubject" name="mainSubject" placeholder="Your specialization subject">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="batch">Batch/Graduation Year</label>
                            <div class="input-group">
                                <i class="fas fa-calendar"></i>
                                <select id="batch" name="batch">
                                    <option value="">Select graduation year</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="offeredSubjects">Subjects You Teach</label>
                            <div class="checkbox-group" id="offeredSubjects">
                                <label class="checkbox-container">
                                    <input type="checkbox" name="offeredSubjects" value="Physics">
                                    <span class="checkmark"></span>Physics
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="offeredSubjects" value="Chemistry">
                                    <span class="checkmark"></span>Chemistry
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="offeredSubjects" value="Mathematics">
                                    <span class="checkmark"></span>Mathematics
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="offeredSubjects" value="Biology">
                                    <span class="checkmark"></span>Biology
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="offeredSubjects" value="English">
                                    <span class="checkmark"></span>English
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="offeredSubjects" value="Bangla">
                                    <span class="checkmark"></span>Bangla
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="classLevels">Class Levels You Teach</label>
                            <div class="checkbox-group" id="classLevels">
                                <label class="checkbox-container">
                                    <input type="checkbox" name="classLevels" value="Class 6">
                                    <span class="checkmark"></span>Class 6
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="classLevels" value="Class 7">
                                    <span class="checkmark"></span>Class 7
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="classLevels" value="Class 8">
                                    <span class="checkmark"></span>Class 8
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="classLevels" value="Class 9">
                                    <span class="checkmark"></span>Class 9
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="classLevels" value="SSC">
                                    <span class="checkmark"></span>SSC
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="classLevels" value="HSC">
                                    <span class="checkmark"></span>HSC
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="experienceYears">Years of Experience</label>
                            <div class="input-group">
                                <i class="fas fa-clock"></i>
                                <input type="number" id="experienceYears" name="experienceYears" min="0" placeholder="Years of teaching experience">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="studentSearch">Search & Connect Available Students (Optional)</label>
                            <div class="input-group">
                                <i class="fas fa-search"></i>
                                <input type="text" id="studentSearch" placeholder="Search available students (only students without tutors will appear)">
                            </div>
                            <div id="studentResults" class="search-results"></div>
                            <div id="selectedStudents" class="selected-items"></div>
                            <small class="form-hint">Only students without tutors can be selected</small>
                        </div>
                    </div>

                    <!-- Parent Specific Fields -->
                    <div id="parentFields" class="role-fields" style="display: none;">
                        <div class="form-group">
                            <label for="parentStudentSearch">Select Your Children (Students) <span style="color: red;">*</span></label>
                            <div class="input-group">
                                <i class="fas fa-search"></i>
                                <input type="text" id="parentStudentSearch" placeholder="Search your child by name, email, or username">
                            </div>
                            <div id="parentStudentResults" class="search-results"></div>
                            <div id="selectedChildrenStudents" class="selected-items"></div>
                            <small class="form-hint">You must select at least one child (student) to continue. If your child is not found, ask them to register first. Only students without parents can be selected.</small>
                        </div>


                    </div>
                </div>

                <!-- Step 3: Address & Security -->
                <div class="step" id="step3">
                    <h3>Address & Security</h3>

                    <div class="form-group">
                        <label for="district">District</label>
                        <div class="input-group">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="district" name="district" required readonly placeholder="Click 'Generate Location' to auto-fill">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="upazila">Upazila</label>
                        <div class="input-group">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="upazila" name="upazila" required readonly placeholder="Will be auto-filled with district">
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="button" id="generateLocationBtn" class="auth-btn secondary" style="width: 100%;">
                            <i class="fas fa-map-marker-alt"></i> Auto-fill District & Upazila
                        </button>
                        <small class="form-hint">This will detect your current location and auto-fill district and upazila</small>
                    </div>

                    <div class="form-group">
                        <label for="city">City/Area</label>
                        <div class="input-group">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="city" name="city" required placeholder="Enter your city or area">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="bkashNumber">bKash Number (Optional)</label>
                        <div class="input-group">
                            <i class="fas fa-mobile-alt"></i>
                            <input type="tel" id="bkashNumber" name="bkashNumber" placeholder="Enter bKash number for payments">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="bio">Bio (Optional)</label>
                        <textarea id="bio" name="bio" placeholder="Tell us about yourself" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="input-group">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="password" name="password" required placeholder="Create a strong password">
                            <button type="button" class="password-toggle" onclick="togglePassword('password')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength" id="passwordStrength"></div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <div class="input-group">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm your password">
                            <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-container">
                            <input type="checkbox" id="agreeTerms" required>
                            <span class="checkmark"></span>
                            I agree to the <a href="#" target="_blank">Terms of Service</a> and <a href="#" target="_blank">Privacy Policy</a>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-container">
                            <input type="checkbox" id="subscribeNewsletter">
                            <span class="checkmark"></span>
                            Subscribe to newsletter for updates
                        </label>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="step-navigation">
                    <button type="button" id="prevBtn" class="auth-btn secondary" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button type="button" id="nextBtn" class="auth-btn primary">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                    <button type="submit" id="submitBtn" class="auth-btn primary" style="display: none;">
                        <span class="btn-text">Create Account</span>
                        <div class="btn-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </button>
                </div>

                <!-- Progress Indicator -->
                <div class="progress-indicator">
                    <div class="progress-step active">1</div>
                    <div class="progress-step">2</div>
                    <div class="progress-step">3</div>
                </div>
            </form>

            <div class="auth-links">
                <p>Already have an account? <a href="login.html">Sign in here</a></p>
            </div>

            <div class="alert-message" id="alertMessage" style="display: none;"></div>
        </div>
    </div>

    <script src="../js/supabase-config.js"></script>
    <script src="../js/upload.js"></script>
    <script src="../data/address.js"></script>
    <script src="../js/api/user.js"></script>
    <script src="../js/api/exam.js"></script>
    <script src="../js/api/proctor.js"></script>
    <script src="../js/api/evaluation.js"></script>
    <script src="../js/api/payment.js"></script>
    <script src="../js/backend-init.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/theme.js"></script>
    <script>
        let currentStep = 1;
        const totalSteps = 3;

        // Global variables for selections
        let selectedTutors = [];
        let selectedParents = [];
        let selectedStudents = [];
        let selectedChildrenStudents = [];
        let selectedChildrenTutors = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            initializeEventListeners();
            populateYearSelectors();
        });

        // Handle role selection changes
        function handleRoleChange() {
            const roleSelect = document.getElementById('role');
            const selectedRole = roleSelect.value;
            const step2Title = document.getElementById('step2Title');

            // Hide all role-specific fields
            document.querySelectorAll('.role-fields').forEach(field => {
                field.style.display = 'none';
            });

            // Show relevant fields based on role
            switch(selectedRole) {
                case 'student':
                    document.getElementById('studentFields').style.display = 'block';
                    step2Title.textContent = 'Student Information';
                    // Load tutors when student is selected
                    loadAllTutors();
                    break;
                case 'tutor':
                    document.getElementById('tutorFields').style.display = 'block';
                    step2Title.textContent = 'Tutor Information';
                    break;
                case 'parent':
                    document.getElementById('parentFields').style.display = 'block';
                    step2Title.textContent = 'Parent Information';
                    break;
                default:
                    step2Title.textContent = 'Role-specific Information';
            }
        }

        // Populate year selectors
        function populateYearSelectors() {
            const currentYear = new Date().getFullYear();

            // SSC Batch years (current year to current year + 3)
            const sscSelect = document.getElementById('sscBatch');
            for (let year = currentYear; year <= currentYear + 3; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                sscSelect.appendChild(option);
            }

            // Graduation years (1980 to current year + 5)
            const batchSelect = document.getElementById('batch');
            for (let year = 1980; year <= currentYear + 5; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                batchSelect.appendChild(option);
            }
        }

        // Initialize search handlers and load tutors
        function initializeSearchHandlers() {
            // Debounce function for search
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Search handlers with debouncing for tutor and parent roles
            if (document.getElementById('studentSearch')) {
                document.getElementById('studentSearch').addEventListener('input', 
                    debounce(e => searchUsers(e.target.value, 'student', 'studentResults'), 300));
            }

            if (document.getElementById('parentStudentSearch')) {
                document.getElementById('parentStudentSearch').addEventListener('input', 
                    debounce(e => searchUsers(e.target.value, 'student', 'parentStudentResults'), 300));
            }


        }

        // Load all tutors for student selection
        async function loadAllTutors() {
            const tutorsList = document.getElementById('tutorsList');

            try {
                // Wait for backend to be ready
                await window.waitForBackend();

                console.log('Loading tutors from database...');

                // First, let's check if there are any users at all
                const { data: allUsers, error: allUsersError } = await window.supabaseClient
                    .from('user_information')
                    .select('user_id, full_name, email, username, role')
                    .order('full_name');

                console.log('All users in database:', allUsers);
                console.log('User roles breakdown:', allUsers?.map(u => `${u.full_name}: ${u.role}`).join(', '));

                if (allUsersError) {
                    console.error('Error fetching all users:', allUsersError);
                }

                // Check each role count
                const roleCounts = {};
                allUsers?.forEach(user => {
                    roleCounts[user.role] = (roleCounts[user.role] || 0) + 1;
                });
                console.log('Role counts:', roleCounts);

                // Now get only tutors with detailed debugging
                console.log('Executing tutor query...');
                const { data, error } = await window.supabaseClient
                    .from('user_information')
                    .select('user_id, full_name, email, username, role')
                    .eq('role', 'tutor')
                    .order('full_name');

                console.log('Tutors found:', data);
                console.log('Query error:', error);
                console.log('Query returned:', data?.length || 0, 'tutors');

                // Check for case sensitivity or whitespace issues
                const tutorLikeRoles = allUsers?.filter(user => 
                    user.role && user.role.toLowerCase().includes('tutor')
                );
                console.log('Users with tutor-like roles:', tutorLikeRoles);

                // Also check auth.users table to see if there are users not in user_information
                try {
                    const { data: authUsers, error: authError } = await window.supabaseClient.auth.admin.listUsers();
                    console.log('Total auth users:', authUsers?.users?.length || 0);
                    console.log('Auth users details:', authUsers?.users?.map(u => ({
                        id: u.id,
                        email: u.email,
                        created_at: u.created_at
                    })));
                } catch (authErr) {
                    console.log('Cannot access auth users (requires admin):', authErr.message);
                }

                // Check if there are any orphaned entries in role-specific tables
                const { data: tutorAdditionalInfo } = await window.supabaseClient
                    .from('tutor_additional_info')
                    .select('user_id');
                console.log('Tutor additional info records:', tutorAdditionalInfo?.length || 0);

                const { data: studentAdditionalInfo } = await window.supabaseClient
                    .from('student_additional_info')
                    .select('user_id');
                console.log('Student additional info records:', studentAdditionalInfo?.length || 0);

                // Check auth context and RLS policies
                const { data: { user: currentUser } } = await window.supabaseClient.auth.getUser();
                console.log('Current user context:', currentUser?.id, currentUser?.email);

                // Try querying with explicit conditions and debug RLS
                const { data: rlsTestAll, error: rlsError1 } = await window.supabaseClient
                    .from('user_information')
                    .select('user_id, full_name, role')
                    .neq('role', 'student'); // Get all non-students
                console.log('RLS test - all non-students:', rlsTestAll?.length || 0);

                const { data: rlsTestTutor, error: rlsError2 } = await window.supabaseClient
                    .from('user_information')
                    .select('user_id, full_name, role')
                    .ilike('role', 'tutor'); // Case-insensitive match
                console.log('RLS test - tutor ilike:', rlsTestTutor?.length || 0);

                const { data: rlsTestTutorExact, error: rlsError3 } = await window.supabaseClient
                    .from('user_information')
                    .select('user_id, full_name, role')
                    .eq('role', 'tutor'); // Exact match
                console.log('RLS test - tutor exact:', rlsTestTutorExact?.length || 0);

                console.log('RLS errors:', { rlsError1, rlsError2, rlsError3 });

                if (error) throw error;

                if (!data || data.length === 0) {
                    // Show role breakdown for debugging
                    const roleBreakdown = allUsers?.map(u => `${u.full_name}: "${u.role}"`).join('<br>') || 'No users found';

                    tutorsList.innerHTML = `
                        <div class="no-tutors">
                            <div style="text-align: center; padding: 2rem;">
                                <i class="fas fa-user-tie" style="font-size: 3rem; color: var(--text-color-muted); margin-bottom: 1rem;"></i>
                                <h4 style="margin-bottom: 0.5rem;">No Tutors Available</h4>
                                <p style="margin-bottom: 1rem; color: var(--text-color-muted);">
                                    Query for role='tutor' returned 0 results.
                                </p>
                                <small style="color: var(--text-color-muted); display: block; margin-bottom: 1rem;">
                                    Total users: ${allUsers ? allUsers.length : 0} | Tutors: 0
                                </small>
                                <div style="background: var(--info-color-light); border: 1px solid var(--info-color); border-radius: 8px; padding: 1rem; margin-top: 1rem; font-size: 0.875rem;">
                                    <strong style="color: var(--info-color);">üîç Debug Info:</strong><br>
                                    <div style="text-align: left; margin-top: 0.5rem; color: var(--text-color-muted);">
                                        All users and their roles:<br>
                                        ${roleBreakdown}
                                    </div>
                                </div>
                                <div style="background: var(--warning-color-light); border: 1px solid var(--warning-color); border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                                    <strong style="color: var(--warning-color);">‚ö†Ô∏è Possible Issues:</strong><br>
                                    <span style="color: var(--text-color-muted); font-size: 0.875rem;">
                                        ‚Ä¢ Check if role values have extra spaces or different case<br>
                                        ‚Ä¢ Verify users have role exactly as 'tutor' (case-sensitive)<br>
                                        ‚Ä¢ Check RLS policies on user_information table
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }

                const tutorsHTML = data.map(tutor => `
                    <div class="tutor-item">
                        <label class="checkbox-container">
                            <input type="checkbox" name="selectedTutors" value="${tutor.user_id}" data-name="${tutor.full_name}" data-email="${tutor.email}">
                            <span class="checkmark"></span>
                            <div class="tutor-info">
                                <div class="tutor-name">${tutor.full_name}</div>
                                <div class="tutor-email">${tutor.email}</div>
                            </div>
                        </label>
                    </div>
                `).join('');

                tutorsList.innerHTML = tutorsHTML;

                // Add change listeners to update selectedTutors array
                const checkboxes = tutorsList.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', updateSelectedTutors);
                });

                console.log(`Successfully loaded ${data.length} tutors`);

            } catch (error) {
                console.error('Error loading tutors:', error);
                tutorsList.innerHTML = `
                    <div class="error-loading">
                        <p>Failed to load tutors</p>
                        <small style="color: var(--text-color-muted); margin-top: 0.5rem; display: block;">
                            Error: ${error.message}
                        </small>
                        <button type="button" onclick="loadAllTutors()" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Update selected tutors array
        function updateSelectedTutors() {
            selectedTutors = [];
            const checkboxes = document.querySelectorAll('input[name="selectedTutors"]:checked');
            checkboxes.forEach(checkbox => {
                selectedTutors.push({
                    user_id: checkbox.value,
                    full_name: checkbox.dataset.name,
                    email: checkbox.dataset.email
                });
            });
            console.log('Selected tutors:', selectedTutors);
        }

        // Search users by role
        async function searchUsers(query, role, resultsContainerId) {
            const resultsContainer = document.getElementById(resultsContainerId);

            if (query.length < 2) {
                resultsContainer.innerHTML = '';
                return;
            }

            try {
                // Wait for backend to be ready
                await window.waitForBackend();

                let data;

                // For tutor searching students, use getAvailableStudents to filter out students with tutors
                if (role === 'student' && resultsContainerId === 'studentResults') {
                    console.log('Searching available students for tutor...');
                    const availableStudents = await window.userAPI.getAvailableStudents();
                    
                    // Filter based on search query
                    data = availableStudents.filter(student => 
                        student.full_name.toLowerCase().includes(query.toLowerCase()) ||
                        student.email.toLowerCase().includes(query.toLowerCase())
                    ).slice(0, 5); // Limit to 5 results
                    
                    console.log('Filtered available students:', data);
                } else {
                    // For other searches (like parent searching students), use regular search
                    const { data: searchData, error } = await window.supabaseClient
                        .from('user_information')
                        .select('user_id, full_name, email, username')
                        .eq('role', role)
                        .or(`full_name.ilike.%${query}%,email.ilike.%${query}%,username.ilike.%${query}%`)
                        .limit(5);

                    if (error) throw error;
                    data = searchData;
                }

                displaySearchResults(data, resultsContainerId);
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<div class="search-error">Search failed. Please try again.</div>';
            }
        }

        // Display search results
        function displaySearchResults(users, resultsContainerId) {
            const resultsContainer = document.getElementById(resultsContainerId);

            if (users.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">No users found</div>';
                return;
            }

            const resultsHTML = users.map(user => `
                <div class="search-result-item" onclick="selectUser('${user.user_id}', '${user.full_name}', '${user.email}', '${resultsContainerId}')">
                    <div class="user-info">
                        <div class="user-name">${user.full_name}</div>
                        <div class="user-email">${user.email}</div>
                    </div>
                </div>
            `).join('');

            resultsContainer.innerHTML = resultsHTML;
        }

        // Select user from search results
        function selectUser(userId, fullName, email, resultsContainerId) {
            // Determine which selection array to use
            let selectedArray;
            let selectedContainerId;

            switch(resultsContainerId) {
                case 'tutorResults':
                    selectedArray = selectedTutors;
                    selectedContainerId = 'selectedTutors';
                    break;
                case 'parentResults':
                    selectedArray = selectedParents;
                    selectedContainerId = 'selectedParents';
                    break;
                case 'studentResults':
                    selectedArray = selectedStudents;
                    selectedContainerId = 'selectedStudents';
                    break;
                case 'parentStudentResults':
                    selectedArray = selectedChildrenStudents;
                    selectedContainerId = 'selectedChildrenStudents';
                    break;

            }

            // Check if already selected
            if (selectedArray.some(user => user.user_id === userId)) {
                showAlert('User already selected', 'warning');
                return;
            }

            // Add to selection
            selectedArray.push({ user_id: userId, full_name: fullName, email });

            // Update display
// Update display
            updateSelectedUsersDisplay(selectedArray, selectedContainerId);

            // Clear search results
            document.getElementById(resultsContainerId).innerHTML = '';

            showAlert(`${fullName} added successfully`, 'success');
        }

        // Update selected users display
        function updateSelectedUsersDisplay(selectedArray, containerId) {
            const container = document.getElementById(containerId);

            const selectedHTML= selectedArray.map((user, index) => `
                <div class="selected-item">
                    <span class="selected-user-name">${user.full_name}</span>
                    <button type="button" class="remove-selected" onclick="removeSelectedUser(${index}, '${containerId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');

            container.innerHTML = selectedHTML;
        }

        // Remove selected user
        function removeSelectedUser(index, containerId) {
            let selectedArray;

            switch(containerId) {
                case 'selectedTutors':
                    selectedArray = selectedTutors;
                    break;
                case 'selectedParents':
                    selectedArray = selectedParents;
                    break;
                case 'selectedStudents':
                    selectedArray = selectedStudents;
                    break;
                case 'selectedChildrenStudents':
                    selectedArray = selectedChildrenStudents;
                    break;

            }

            selectedArray.splice(index, 1);
            updateSelectedUsersDisplay(selectedArray, containerId);
        }

        // Store location coordinates globally for use in registration
        let userLocationCoordinates = null;

        // Generate location from current position
        async function generateLocation() {
            const generateBtn = document.getElementById('generateLocationBtn');
            const districtInput = document.getElementById('district');
            const upazilaInput = document.getElementById('upazila');

            try {
                // Show loading state
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting Location...';

                // Get current position
                const position = await window.locationUtils.getCurrentLocation();
                console.log('Location detected:', position);

                // Store coordinates for Google Maps URL generation
                userLocationCoordinates = {
                    latitude: position.latitude,
                    longitude: position.longitude
                };

                // Update button to show progress
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Address Details...';

                // Get location details
                const locationDetails = await window.locationUtils.getLocationFromCoordinates(
                    position.latitude, 
                    position.longitude
                );

                console.log('Location details received:', locationDetails);

                // Validate the extracted data
                if (!locationDetails.district) {
                    throw new Error('Could not determine district from location');
                }

                // Fill form fields
                if (locationDetails.district) {
                    districtInput.value = locationDetails.district;
                    districtInput.style.color = '#20bf6b';
                }

                if (locationDetails.upazila) {
                    upazilaInput.value = locationDetails.upazila;
                    upazilaInput.style.color = '#20bf6b';
                }

                // Show success message
                const message = locationDetails.upazila ? 
                    'District and Upazila detected successfully!' : 
                    'District detected successfully!';
                showAlert(message, 'success');

                generateBtn.innerHTML = '<i class="fas fa-check"></i> Location Generated';
                generateBtn.style.backgroundColor = '#20bf6b';

            } catch (error) {
                console.error('Error generating location:', error);

                // Provide more specific error messages
                let errorMessage = 'Failed to detect location. ';
                if (error.message.includes('User denied')) {
                    errorMessage += 'Please allow location access and try again.';
                } else if (error.message.includes('network')) {
                    errorMessage += 'Network error. Please check your internet connection.';
                } else {
                    errorMessage += 'Please ensure location access is enabled and try again.';
                }

                showAlert(errorMessage, 'error');
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Auto-fill District & Upazila';
                generateBtn.style.backgroundColor = '';
            }
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Role selection handler
            document.getElementById('role').addEventListener('change', handleRoleChange);

            // Generate location button
            document.getElementById('generateLocationBtn').addEventListener('click', generateLocation);

            // Search functionality
            initializeSearchHandlers();

            // Profile picture preview
            document.getElementById('profilePicture').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('profilePreview');
                        const img = preview.querySelector('img');
                        const label = document.querySelector('label[for="profilePicture"]');

                        img.src = e.target.result;
                        preview.style.display = 'block';
                        label.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Password strength checker
            document.getElementById('password').addEventListener('input', checkPasswordStrength);

            // Step navigation
            document.getElementById('nextBtn').addEventListener('click', function(e) {
                e.preventDefault();
                nextStep();
            });

            document.getElementById('prevBtn').addEventListener('click', function(e) {
                e.preventDefault();
                prevStep();
            });

            // Form submission
            document.getElementById('registerForm').addEventListener('submit', handleSubmit);
        }

        // Preview uploaded image
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            const img = preview.querySelector('img');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                    input.nextElementSibling.style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Remove uploaded image
        function removeImage(inputId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(inputId.replace('Picture', 'Preview'));

            input.value = '';
            preview.style.display = 'none';
            input.nextElementSibling.style.display = 'block';
        }

        // Password toggle
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const toggle = field.nextElementSibling;
            const icon = toggle.querySelector('i');

            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Check password strength
        function checkPasswordStrength() {
            const password = document.getElementById('password').value;
            const strengthDiv = document.getElementById('passwordStrength');

            let strength = 0;
            let feedback = [];

            if (password.length >= 8) strength++;
            else feedback.push('At least 8 characters');

            if (/[a-z]/.test(password)) strength++;
            else feedback.push('Lowercase letter');

            if (/[A-Z]/.test(password)) strength++;
            else feedback.push('Uppercase letter');

            if (/[0-9]/.test(password)) strength++;
            else feedback.push('Number');

            if (/[^A-Za-z0-9]/.test(password)) strength++;
            else feedback.push('Special character');

            const levels = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
            const colors = ['#ff4757', '#ff6b7a', '#ffa502', '#2ed573', '#20bf6b'];

            strengthDiv.innerHTML = `
                <div class="strength-bar">
                    <div class="strength-fill" style="width: ${(strength / 5) * 100}%; background-color: ${colors[strength - 1] || '#ddd'}"></div>
                </div>
                <div class="strength-text" style="color: ${colors[strength - 1] || '#666'}">
                    ${password ? levels[strength - 1] || 'Very Weak' : ''}
                    ${feedback.length ? ` - Missing: ${feedback.join(', ')}` : ''}
                </div>
            `;
        }

        // Step navigation
        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < totalSteps) {
                    document.getElementById(`step${currentStep}`).classList.remove('active');
                    currentStep++;
                    document.getElementById(`step${currentStep}`).classList.add('active');
                    updateStepNavigation();
                    updateProgressIndicator();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateStepNavigation();
                updateProgressIndicator();
            }
        }

        function updateStepNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');

            prevBtn.style.display = currentStep > 1 ? 'inline-block' : 'none';
            nextBtn.style.display = currentStep < totalSteps ? 'inline-block' : 'none';
            submitBtn.style.display = currentStep === totalSteps ? 'inline-block' : 'none';
        }

        function updateProgressIndicator() {
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                if (index < currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }

        // Validate current step
        function validateCurrentStep() {
            const currentStepElement = document.getElementById(`step${currentStep}`);
            // Only check required fields that are visible and not in hidden role fields
            const requiredFields = currentStepElement.querySelectorAll('[required]');
            let isValid = true;
            let emptyFields = [];

            requiredFields.forEach(field => {
                // Skip validation for fields in hidden role sections
                const parentRoleField = field.closest('.role-fields');
                if (parentRoleField && parentRoleField.style.display === 'none') {
                    return; // Skip this field as it's in a hidden role section
                }

                // Skip validation for fields that are not visible
                if (field.offsetParent === null && field.type !== 'hidden') {
                    return; // Skip hidden fields
                }

                if (!field.value.trim()) {
                    field.classList.add('error');
                    emptyFields.push(field.getAttribute('name') || field.id || 'Unknown field');
                    isValid = false;
                } else {
                    field.classList.remove('error');
                }
            });

            // Additional validation for step 2
            if (currentStep === 2) {
                const role = document.getElementById('role').value;

                // Check if student role and validate tutor selection
                if (role === 'student') {
                    if (selectedTutors.length === 0) {
                        showAlert('You must select at least one tutor to continue', 'error');
                        document.getElementById('tutorsList').classList.add('error');
                        isValid = false;
                    } else {
                        document.getElementById('tutorsList').classList.remove('error');
                    }
                }

                // Check if parent role and validate child selection
                if (role === 'parent') {
                    if (selectedChildrenStudents.length === 0) {
                        showAlert('You must select at least one child (student) to continue', 'error');
                        document.getElementById('selectedChildrenStudents').classList.add('error');
                        isValid = false;
                    } else {
                        document.getElementById('selectedChildrenStudents').classList.remove('error');
                    }
                }
            }

            // Additional validation for step 3
            if (currentStep === 3) {
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (password !== confirmPassword) {
                    showAlert('Passwords do not match', 'error');
                    document.getElementById('confirmPassword').classList.add('error');
                    isValid = false;
                }

                if (password.length < 8) {
                    showAlert('Password must be at least 8 characters long', 'error');
                    document.getElementById('password').classList.add('error');
                    isValid = false;
                }
            }

            if (!isValid && currentStep !== 2) {
                if (emptyFields.length > 0) {
                    console.log('Empty required fields:', emptyFields);
                    showAlert('Please fill in all required fields', 'error');
                } else {
                    showAlert('Please check the form for errors', 'error');
                }
            }

            return isValid;
        }

        // Upload image to Supabase storage
        async function uploadImage(file, bucket, folder = '') {
            try {
                if (!file) return null;

                const fileExt = file.name.split('.').pop();
                const fileName = `${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
                const filePath = folder ? `${folder}/${fileName}` : fileName;

                // Wait for supabase to be ready
                while (!window.SUPABASE_CONFIG?.getClient()) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                const { data, error } = await window.SUPABASE_CONFIG.getClient()
                    .storage
                    .from(bucket)
                    .upload(filePath, file);

                if (error) {
                    console.error('Storage upload error:', error);
                    return null; // Return null for RLS errors to continue registration
                }

                // Get public URL
                const { data: urlData } = window.SUPABASE_CONFIG.getClient()
                    .storage
                    .from(bucket)
                    .getPublicUrl(filePath);

                return urlData.publicUrl;
            } catch (error) {
                console.error('Error uploading image:', error);
                return null; // Return null instead of throwing to continue registration
            }
        }

        // Handle form submission
        async function handleSubmit(e) {
            e.preventDefault();

            if (!validateCurrentStep()) return;

            const submitBtn = document.getElementById('submitBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');

            // Show loading state
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            submitBtn.disabled = true;

            try {
                // Wait for backend to be ready
                await window.waitForBackend();

                const formData = new FormData(e.target);
                const userData = {};

                // Collect form data
                for (let [key, value] of formData.entries()) {
                    if (key !== 'profilePicture') {
                        userData[key] = value;
                    }
                }

                // Collect checkbox values for subjects and class levels
                const offeredSubjects = Array.from(document.querySelectorAll('input[name="offeredSubjects"]:checked'))
                    .map(cb => cb.value);
                const classLevels = Array.from(document.querySelectorAll('input[name="classLevels"]:checked'))
                    .map(cb => cb.value);

                // Add role-specific data
                if (userData.role === 'student') {
                    userData.studentInfo = {
                        institution: userData.institution,
                        ssc_batch: userData.sscBatch,
                        tutors: selectedTutors.map(t => t.user_id),
                        parents: selectedParents.map(p => p.user_id)
                    };

                    // Generate Google Maps location URL if coordinates are available
                    if (userLocationCoordinates) {
                        const googleMapsUrl = `https://www.google.com/maps?q=${userLocationCoordinates.latitude},${userLocationCoordinates.longitude}`;
                        userData.studentInfo.location_qr = googleMapsUrl;
                        console.log('Generated Google Maps URL for student:', googleMapsUrl);
                    } else if (userData.district && userData.city) {
                        // Fallback to text-based location if coordinates not available
                        const fallbackMapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(userData.district + ', ' + userData.city + ', Bangladesh')}`;
                        userData.studentInfo.location_qr = fallbackMapsUrl;
                        console.log('Generated fallback Google Maps URL for student:', fallbackMapsUrl);
                    }
                } else if (userData.role === 'tutor') {
                    const tutorsList = document.getElementById('tutorsList');
                    // Populate tutors section with available students
                        console.log('Loading students for tutor...');
                        try {
                            const availableStudents = await window.userAPI.getAvailableStudents();
                            console.log('Available students for tutor:', availableStudents);

                            if (!availableStudents || availableStudents.length === 0) {
                                tutorsList.innerHTML = `
                                    <h4>Select Students to Connect:</h4>
                                    <p class="help-text">No available students found. All students already have tutors connected.</p>
                                `;
                                return;
                            }

                            const studentsHTML = availableStudents.map(student => `
                                <div class="student-option">
                                    <input type="checkbox" 
                                           id="student-${student.user_id}" 
                                           name="students" 
                                           value="${student.user_id}">
                                    <label for="student-${student.user_id}">
                                        ${student.full_name} (${student.email})
                                    </label>
                                </div>
                            `).join('');

                            tutorsList.innerHTML = `
                                <h4>Select Students to Connect:</h4>
                                <p class="help-text">Choose students you want to connect with during registration (only students without tutors are shown)</p>
                                ${studentsHTML}
                            `;
                        } catch (error) {
                            console.error('Error loading students for tutor:', error);
                            tutorsList.innerHTML = `
                                <h4>Select Students to Connect:</h4>
                                <p class="error">Error loading available students. Please try again.</p>
                            `;
                        }
                    userData.tutorInfo = {
                        institution: userData.tutorInstitution,
                        subject: userData.mainSubject,
                        batch: userData.batch,
                        offered_subjects: offeredSubjects,
                        class_levels: classLevels,
                        experience_years: userData.experienceYears ? parseInt(userData.experienceYears) : 0,
                        students: selectedStudents.map(s => s.user_id)
                    };
                    console.log('Selected students for tutor:', selectedStudents.map(s => s.user_id));
                } else if (userData.role === 'parent') {
                    userData.parentInfo = {
                        students: selectedChildrenStudents.map(s => s.user_id),
                        tutors: selectedChildrenTutors.map(t => t.user_id)
                    };
                }

                // Location data is now handled directly through form fields

                // Upload profile picture if provided
                const profilePictureFile = document.getElementById('profilePicture').files[0];
                if (profilePictureFile) {
                    try {
                        userData.profile_picture = await uploadImage(profilePictureFile, 'uploads', 'profile-pictures');
                    } catch (uploadError) {
                        console.warn('Image upload failed, continuing without profile picture:', uploadError);
                    }
                }

                // Register user
                const result = await window.userAPI.registerUser(userData);

                if (result.success) {
                    // Clear any existing session data
                    window.authManager.clearUserSession();

                    // Sign out from Supabase as well
                    if (window.supabaseClient) {
                        await window.supabaseClient.auth.signOut();
                    }

                    // Show success message
                    showAlert('Registration successful! Please check your email to verify your account before logging in.', 'success');

                    // Redirect to login page after 3 seconds
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 3000);
                } else {
                    showAlert(result.error || 'Registration failed. Please try again.');
                }
            } catch (error) {
                showAlert('An error occurred during registration. Please try again.');
                console.error('Registration error:', error);
            } finally {
                // Reset button state
                btnText.style.display = 'inline-block';
                btnLoader.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        // Show alert message
        function showAlert(message, type = 'error') {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.textContent = message;
            alertDiv.className = `alert-message ${type}`;
            alertDiv.style.display = 'block';

            // Auto-hide success and warning messages after 5 seconds, keep errors visible
            if (type === 'success' || type === 'warning') {
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 5000);
            }
        }

        async function searchStudents() {
                            const query = document.getElementById('parentStudentSearch').value.trim();
                            const resultsContainer = document.getElementById('parentStudentResults');

                            if (query.length < 2) {
                                resultsContainer.innerHTML = '';
                                return;
                            }

                            try {
                                // Get all students matching the search query
                                const { data: users, error } = await window.supabaseClient
                                    .from('user_information')
                                    .select('user_id, username, full_name, email')
                                    .eq('role', 'student')
                                    .or(`full_name.ilike.%${query}%, username.ilike.%${query}%, email.ilike.%${query}%`)
                                    .limit(10);

                                if (error) throw error;

                                // Filter out students who already have parents
                                const availableStudents = [];

                                for (const student of users || []) {
                                    const { data: studentInfo, error: studentError } = await window.supabaseClient
                                        .from('student_additional_info')
                                        .select('parents')
                                        .eq('user_id', student.user_id)
                                        .single();

                                    // Include student only if they have no parents or empty parents array
                                    if (studentError && studentError.code === 'PGRST116') {
                                        // No record exists, student is available
                                        availableStudents.push(student);
                                    } else if (!studentError) {
                                        const parents = studentInfo?.parents || [];
                                        if (parents.length === 0) {
                                            // Student has no parents, available for selection
                                            availableStudents.push(student);
                                        }
                                    }
                                }

                                displayStudentResults(availableStudents);
                            } catch (error) {
                                console.error('Error searching students:', error);
                                resultsContainer.innerHTML = '<div class="error">Error searching students</div>';
                            }
                        }
    </script>
</body>
</html>