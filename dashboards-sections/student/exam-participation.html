
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iCup Exam Participation</title>
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/theme.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .participation-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: var(--background-color);
            min-height: 100vh;
        }

        .header-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: var(--shadow-medium);
        }

        .back-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .exam-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--text-primary);
            text-align: center;
            flex-grow: 1;
            margin: 0 20px;
        }

        .theme-toggle {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .section {
            background: linear-gradient(135deg, var(--surface-color) 0%, var(--background-color) 100%);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .section-header i {
            color: var(--primary-color);
            font-size: 1.4rem;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metadata-item {
            background: var(--background-color);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease;
        }

        .metadata-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .metadata-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .metadata-value {
            font-size: 1.1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .proctor-info {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-medium);
        }

        .proctor-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .proctor-details {
            margin-top: 15px;
        }

        .proctor-avatar-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .proctor-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            flex-shrink: 0;
            overflow: hidden;
            border: 3px solid var(--border-color);
            box-shadow: var(--shadow-medium);
        }

        .proctor-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .proctor-info-text {
            flex: 1;
        }

        #proctorContact {
            background: var(--background-color);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-top: 10px;
        }

        .countdown-section {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: var(--shadow-large);
        }

        .countdown-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .countdown-timer {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .time-unit {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            min-width: 80px;
        }

        .time-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }

        .time-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .upload-status {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-medium);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: var(--success-light);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .alert-warning {
            background: var(--warning-light);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }

        .alert-info {
            background: var(--info-light);
            color: var(--info-color);
            border: 1px solid var(--info-color);
        }

        @media (max-width: 768px) {
            .header-section {
                flex-direction: column;
                gap: 15px;
            }

            .exam-title {
                font-size: 2rem;
                margin: 0;
            }

            .countdown-timer {
                flex-wrap: wrap;
                gap: 10px;
            }

            .time-unit {
                min-width: 60px;
                padding: 10px;
            }

            .time-number {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="participation-container">
        <!-- Header Section -->
        <div class="header-section">
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
                Back
            </button>
            <h1 class="exam-title" id="examTitle">iCup Exam Participation</h1>
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <!-- Loading Message -->
        <div id="loadingMessage" class="section">
            <div class="section-header">
                <div class="loading-spinner"></div>
                <span>Loading exam information...</span>
            </div>
        </div>

        <!-- Core Exam Metadata -->
        <div id="coreMetadata" class="section hidden">
            <div class="section-header">
                <i class="fas fa-info-circle"></i>
                ✅ Core Exam Metadata
            </div>
            <div class="metadata-grid" id="coreMetadataGrid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Scheduling & Availability -->
        <div id="schedulingSection" class="section hidden">
            <div class="section-header">
                <i class="fas fa-calendar"></i>
                📅 Scheduling & Availability
            </div>
            <div class="metadata-grid" id="schedulingGrid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Evaluation & Marking -->
        <div id="evaluationSection" class="section hidden">
            <div class="section-header">
                <i class="fas fa-flask"></i>
                🧪 Evaluation & Marking
            </div>
            <div class="metadata-grid" id="evaluationGrid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Question Mark Distribution -->
        <div id="questionMarksSection" class="section hidden">
            <div class="section-header">
                <i class="fas fa-question"></i>
                Question Mark Distribution
            </div>
            <div class="metadata-grid" id="questionMarksGrid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Miscellaneous -->
        <div id="miscSection" class="section hidden">
            <div class="section-header">
                <i class="fas fa-asterisk"></i>
                🏷️ Miscellaneous
            </div>
            <div class="metadata-grid" id="miscGrid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Proctor Information -->
        <div id="proctorInfo" class="proctor-info hidden">
            <div class="proctor-header">
                <i class="fas fa-user-tie" style="color: var(--primary-color); font-size: 1.5rem;"></i>
                <h3 style="margin: 0; color: var(--text-primary);">Your Proctor for the Exam</h3>
            </div>
            <div class="proctor-details">
                <div class="proctor-avatar-section">
                    <div class="proctor-avatar" id="proctorAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="proctor-info-text">
                        <p id="proctorName" style="font-size: 1.2rem; color: var(--text-primary); margin: 0 0 8px 0; font-weight: 600;">Loading proctor information...</p>
                        <div id="proctorContact" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <i class="fas fa-phone" style="color: var(--primary-color); width: 16px;"></i>
                                <span id="proctorPhone" style="font-size: 0.95rem; color: var(--text-secondary);">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Countdown Section -->
        <div id="countdownSection" class="countdown-section hidden">
            <div class="countdown-title" id="countdownTitle">Time Until Exam Opens</div>
            <div class="countdown-timer">
                <div class="time-unit">
                    <span class="time-number" id="days">00</span>
                    <span class="time-label">Days</span>
                </div>
                <div class="time-unit">
                    <span class="time-number" id="hours">00</span>
                    <span class="time-label">Hours</span>
                </div>
                <div class="time-unit">
                    <span class="time-number" id="minutes">00</span>
                    <span class="time-label">Minutes</span>
                </div>
                <div class="time-unit">
                    <span class="time-number" id="seconds">00</span>
                    <span class="time-label">Seconds</span>
                </div>
            </div>
            <div id="countdownMessage" style="font-size: 1.1rem; opacity: 0.9;"></div>
        </div>

        <!-- Answer Sheet Status -->
        <div id="uploadStatus" class="upload-status hidden">
            <div class="section-header">
                <i class="fas fa-upload"></i>
                Answer Sheet Status
            </div>
            <div id="uploadMessage" class="alert alert-info">
                <i class="fas fa-clock"></i>
                Your answer papers aren't uploaded yet
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../js/supabase-config.js"></script>
    <script src="../../js/api/user.js"></script>
    <script src="../../js/api/exam.js"></script>
    <script src="../../js/api/proctor.js"></script>
    <script src="../../js/api/evaluation.js"></script>
    <script src="../../js/api/payment.js"></script>
    <script src="../../js/backend-init.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/theme.js"></script>

    <script>
        let pageCurrentUser = null;
        let pageCurrentExam = null;
        let countdownInterval = null;

        document.addEventListener('DOMContentLoaded', async function() {
            await waitForBackendServices();
            await loadUserAndExam();
        });

        async function waitForBackendServices() {
            while (!window.backendInitialized && !window.supabaseClient) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        async function loadUserAndExam() {
            try {
                // Get current user
                const authResult = await window.authManager.getCurrentUser();
                if (!authResult) {
                    window.location.href = '../../auth/login.html';
                    return;
                }

                // Extract user data correctly from auth manager response
                pageCurrentUser = {
                    user_id: authResult.user?.id || authResult.profile?.user_id,
                    id: authResult.user?.id || authResult.profile?.user_id,
                    email: authResult.user?.email || authResult.profile?.email,
                    profile: authResult.profile
                };

                console.log('User loaded with ID:', pageCurrentUser.user_id);

                // Get current exam
                const examResult = await window.examAPI.getCurrentExam();
                if (examResult.success && examResult.data) {
                    pageCurrentExam = examResult.data;
                    console.log('Current exam loaded:', pageCurrentExam);

                    // Update exam title
                    const examTitleElement = document.getElementById('examTitle');
                    if (examTitleElement) {
                        examTitleElement.textContent = pageCurrentExam.title || pageCurrentExam.exam_name || 'iCup Exam';
                    }

                    // Load proctor information
                    await loadProctorInfo();

                    // Display exam information
                    displayExamInfo();

                    // Start countdown
                    startCountdown();

                    // Check upload status
                    checkUploadStatus();

                    // Hide loading message
                    const loadingElement = document.getElementById('loadingMessage');
                    if (loadingElement) {
                        loadingElement.classList.add('hidden');
                    }
                } else {
                    showError('No active exam found.');
                }
            } catch (error) {
                console.error('Error loading exam:', error);
                showError('Error loading exam information.');
            }
        }

        async function loadProctorInfo() {
            try {
                const proctorInfoDiv = document.getElementById('proctorInfo');
                const proctorNameDiv = document.getElementById('proctorName');
                const proctorAvatarDiv = document.getElementById('proctorAvatar');
                const proctorPhoneDiv = document.getElementById('proctorPhone');
                const proctorContactDiv = document.getElementById('proctorContact');

                if (!pageCurrentUser || !pageCurrentExam) {
                    if (proctorNameDiv) {
                        proctorNameDiv.textContent = 'Proctor assignment will be available closer to exam time.';
                    }
                    if (proctorInfoDiv) {
                        proctorInfoDiv.classList.remove('hidden');
                    }
                    return;
                }

                // Get the user ID
                const userId = pageCurrentUser.user_id;
                console.log('Looking for proctor assignment for user ID:', userId, 'week:', pageCurrentExam.week_number);
                
                // Validate userId is not undefined or null
                if (!userId || userId === 'undefined' || userId === undefined) {
                    console.error('Invalid user ID for proctor lookup:', userId);
                    console.error('pageCurrentUser object:', pageCurrentUser);
                    if (proctorNameDiv) {
                        proctorNameDiv.textContent = 'Unable to load proctor information - user not properly authenticated.';
                    }
                    return;
                }

                // Get proctor assignment from database
                const { data: proctorAssignment, error } = await window.supabaseClient
                    .from('proctor_allocation')
                    .select('*')
                    .eq('student_id', userId)
                    .eq('week_number', pageCurrentExam.week_number)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading proctor assignment:', error);
                    if (proctorNameDiv) {
                        proctorNameDiv.textContent = 'Error loading proctor information.';
                    }
                } else if (proctorAssignment) {
                    // Get proctor's detailed information from user_information table
                    const { data: proctorDetails, error: proctorError } = await window.supabaseClient
                        .from('user_information')
                        .select('full_name, phone, profile_picture')
                        .eq('user_id', proctorAssignment.proctor_id)
                        .single();

                    if (proctorError) {
                        console.error('Error loading proctor details:', proctorError);
                    }

                    // Update proctor name
                    if (proctorNameDiv) {
                        const proctorName = proctorDetails?.full_name || proctorAssignment.proctor_full_name;
                        proctorNameDiv.innerHTML = `
                            <strong>${proctorName}</strong><br>
                            <small style="opacity: 0.8;">Your assigned proctor for this exam</small>
                        `;
                    }

                    // Update proctor avatar
                    if (proctorAvatarDiv && proctorDetails) {
                        if (proctorDetails.profile_picture) {
                            proctorAvatarDiv.innerHTML = `<img src="${proctorDetails.profile_picture}" alt="${proctorDetails.full_name || 'Proctor'}" />`;
                        } else {
                            // Show initials if no profile picture
                            const initials = (proctorDetails.full_name || proctorAssignment.proctor_full_name || 'P')
                                .split(' ')
                                .map(n => n[0])
                                .join('')
                                .toUpperCase()
                                .substring(0, 2);
                            proctorAvatarDiv.innerHTML = initials;
                        }
                    }

                    // Update proctor phone and show contact section
                    if (proctorPhoneDiv && proctorContactDiv && proctorDetails?.phone) {
                        proctorPhoneDiv.textContent = proctorDetails.phone;
                        proctorContactDiv.style.display = 'block';
                    } else if (proctorContactDiv) {
                        proctorContactDiv.style.display = 'none';
                    }
                } else {
                    // No proctor assigned yet
                    if (proctorNameDiv) {
                        proctorNameDiv.textContent = 'Proctor assignment will be available closer to exam time.';
                    }
                    if (proctorContactDiv) {
                        proctorContactDiv.style.display = 'none';
                    }
                }

                if (proctorInfoDiv) {
                    proctorInfoDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading proctor info:', error);
                const proctorNameDiv = document.getElementById('proctorName');
                if (proctorNameDiv) {
                    proctorNameDiv.textContent = 'Error loading proctor information.';
                }
            }
        }

        function displayExamInfo() {
            if (!pageCurrentExam) return;

            // Core Exam Metadata
            const coreGrid = document.getElementById('coreMetadataGrid');
            if (coreGrid) {
                coreGrid.innerHTML = `
                    <div class="metadata-item">
                        <div class="metadata-label">Exam Name</div>
                        <div class="metadata-value">${pageCurrentExam.title || 'iCup Exam'}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Week Number</div>
                        <div class="metadata-value">Week ${pageCurrentExam.week_number || 'N/A'}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Exam Type</div>
                        <div class="metadata-value">${pageCurrentExam.exam_type || 'Written'}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Duration</div>
                        <div class="metadata-value">${pageCurrentExam.duration_minutes || 180} minutes</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Total Marks</div>
                        <div class="metadata-value">${pageCurrentExam.total_marks || 100} marks</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Questions</div>
                        <div class="metadata-value">${pageCurrentExam.question_count || 'Multiple'}</div>
                    </div>
                `;
                document.getElementById('coreMetadata').classList.remove('hidden');
            }

            // Scheduling & Availability
            const schedulingGrid = document.getElementById('schedulingGrid');
            if (schedulingGrid) {
                const examDate = new Date(pageCurrentExam.scheduled_at);
                const availableFrom = new Date(pageCurrentExam.available_from || pageCurrentExam.scheduled_at);
                const availableUntil = new Date(pageCurrentExam.available_until || new Date(examDate.getTime() + (pageCurrentExam.duration_minutes * 60000)));
                const submitDeadline = new Date(pageCurrentExam.submit_deadline || availableUntil);

                schedulingGrid.innerHTML = `
                    <div class="metadata-item">
                        <div class="metadata-label">Exam Date</div>
                        <div class="metadata-value">${formatDateTime(examDate)}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Available From</div>
                        <div class="metadata-value">${formatDateTime(availableFrom)}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Available Until</div>
                        <div class="metadata-value">${formatDateTime(availableUntil)}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Submit Deadline</div>
                        <div class="metadata-value">${formatDateTime(submitDeadline)}</div>
                    </div>
                `;
                document.getElementById('schedulingSection').classList.remove('hidden');
            }

            // Evaluation & Marking
            const evaluationGrid = document.getElementById('evaluationGrid');
            if (evaluationGrid) {
                const markingDeadline = new Date(pageCurrentExam.marking_deadline || new Date(Date.now() + 2 * 24 * 60 * 60 * 1000));
                
                evaluationGrid.innerHTML = `
                    <div class="metadata-item">
                        <div class="metadata-label">Evaluation Type</div>
                        <div class="metadata-value">${pageCurrentExam.evaluation_type || 'Manual'}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Marking Deadline</div>
                        <div class="metadata-value">${formatDateTime(markingDeadline)}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Partial Marks</div>
                        <div class="metadata-value">${pageCurrentExam.allow_partial_marks ? 'Allowed' : 'Not Allowed'}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Late Submission</div>
                        <div class="metadata-value">${pageCurrentExam.allow_late_submission ? 'Allowed' : 'Not Allowed'}</div>
                    </div>
                `;
                document.getElementById('evaluationSection').classList.remove('hidden');
            }

            // Question Mark Distribution
            const questionMarksGrid = document.getElementById('questionMarksGrid');
            if (questionMarksGrid && pageCurrentExam.question_marks) {
                let marksHtml = '';
                Object.entries(pageCurrentExam.question_marks).forEach(([questionNum, marks]) => {
                    marksHtml += `
                        <div class="metadata-item">
                            <div class="metadata-label">Question ${questionNum}</div>
                            <div class="metadata-value">${marks} marks</div>
                        </div>
                    `;
                });
                questionMarksGrid.innerHTML = marksHtml;
                document.getElementById('questionMarksSection').classList.remove('hidden');
            }

            // Miscellaneous
            const miscGrid = document.getElementById('miscGrid');
            if (miscGrid) {
                miscGrid.innerHTML = `
                    <div class="metadata-item">
                        <div class="metadata-label">Category</div>
                        <div class="metadata-value">${pageCurrentExam.category || 'General'}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Subjects</div>
                        <div class="metadata-value">${Array.isArray(pageCurrentExam.subject) ? pageCurrentExam.subject.join(', ') : (pageCurrentExam.subject || 'All Subjects')}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Grade Level</div>
                        <div class="metadata-value">${pageCurrentExam.grade_level || 'Mixed'}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Difficulty</div>
                        <div class="metadata-value">${pageCurrentExam.difficulty_level || 'Mixed'}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Language</div>
                        <div class="metadata-value">${pageCurrentExam.language || 'Bengali'}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Fee</div>
                        <div class="metadata-value">৳${pageCurrentExam.fee || 50}</div>
                    </div>
                `;
                document.getElementById('miscSection').classList.remove('hidden');
            }
        }

        function startCountdown() {
            if (!pageCurrentExam) return;

            const examStartTime = new Date(pageCurrentExam.available_from || pageCurrentExam.scheduled_at);
            const countdownSection = document.getElementById('countdownSection');

            if (countdownSection) {
                countdownSection.classList.remove('hidden');
            }

            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = examStartTime.getTime() - now;

                if (distance > 0) {
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    const daysElement = document.getElementById('days');
                    const hoursElement = document.getElementById('hours');
                    const minutesElement = document.getElementById('minutes');
                    const secondsElement = document.getElementById('seconds');
                    const messageElement = document.getElementById('countdownMessage');

                    if (daysElement) daysElement.textContent = days.toString().padStart(2, '0');
                    if (hoursElement) hoursElement.textContent = hours.toString().padStart(2, '0');
                    if (minutesElement) minutesElement.textContent = minutes.toString().padStart(2, '0');
                    if (secondsElement) secondsElement.textContent = seconds.toString().padStart(2, '0');
                    if (messageElement) messageElement.textContent = 'Exam will be available soon!';
                } else {
                    clearInterval(countdownInterval);
                    const daysElement = document.getElementById('days');
                    const hoursElement = document.getElementById('hours');
                    const minutesElement = document.getElementById('minutes');
                    const secondsElement = document.getElementById('seconds');
                    const messageElement = document.getElementById('countdownMessage');
                    const countdownTitle = document.getElementById('countdownTitle');

                    if (daysElement) daysElement.textContent = '00';
                    if (hoursElement) hoursElement.textContent = '00';
                    if (minutesElement) minutesElement.textContent = '00';
                    if (secondsElement) secondsElement.textContent = '00';
                    if (countdownTitle) countdownTitle.textContent = 'Exam is Now Available!';
                    if (messageElement) messageElement.textContent = 'You can now start the exam.';
                }
            }, 1000);
        }

        async function checkUploadStatus() {
            try {
                const uploadStatusDiv = document.getElementById('uploadStatus');
                const uploadMessageDiv = document.getElementById('uploadMessage');

                if (uploadMessageDiv) {
                    uploadMessageDiv.innerHTML = `
                        <i class="fas fa-clock"></i>
                        Your answer papers aren't uploaded yet
                    `;
                    uploadMessageDiv.className = 'alert alert-info';
                }

                if (uploadStatusDiv) {
                    uploadStatusDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error checking upload status:', error);
            }
        }

        function formatDateTime(date) {
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showError(message) {
            const loadingElement = document.getElementById('loadingMessage');
            if (loadingElement) {
                loadingElement.innerHTML = `
                    <div class="section-header">
                        <i class="fas fa-exclamation-circle" style="color: var(--error-color);"></i>
                        <span>${message}</span>
                    </div>
                `;
            }
        }

        function goBack() {
            window.location.href = '../../dashboards/student-dashboard.html';
        }

        function toggleTheme() {
            if (window.themeManager) {
                window.themeManager.toggleTheme();
            }
        }

        // Cleanup interval on page unload
        window.addEventListener('beforeunload', function() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
        });
    </script>
</body>
</html>
