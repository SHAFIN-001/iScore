<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor Dashboard</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/theme.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-container {
            min-height: 100vh;
            background: var(--bg-primary);
        }

        .dashboard-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .profile-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background 0.2s;
        }

        .profile-section:hover {
            background: var(--bg-secondary);
        }

        .profile-picture {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--blue-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .tutor-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-btn {
            position: relative;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .notification-btn:hover {
            background: var(--blue-primary);
            color: white;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--red-primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle-btn {
            background: transparent;
            border: none;
            border-radius: 50%;
            cursor: clicker;
            color: var(--text-primary);
            transition: all 0s;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            position: relative;

        }

        .theme-toggle-btn:hover {
            background: none;
            color: darkblue;
            transform: scale(1.25);
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .logout-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: var(--red-dark);
        }

        .dashboard-main {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-welcome {
            margin-bottom: 2rem;
        }

        .dashboard-welcome h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .dashboard-welcome p {
            color: var(--text-secondary);
            font-size: 1.125rem;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .action-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: var(--blue-primary);
        }

        .action-icon {
            width: 60px;
            height: 60px;
            background: var(--blue-gradient);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .action-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .action-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .students-section {
            margin-bottom: 3rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .add-student-btn {
            background: var(--blue-gradient);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .add-student-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .student-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            transition: all 0.2s;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .student-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .student-avatar {
            width: 50px;
            height: 50px;
            background: var(--blue-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .student-info h3 {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .student-info p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .student-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--blue-primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .student-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .remove-student-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .remove-student-btn:hover {
            background: var(--red-dark);
            transform: translateY(-2px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .submit-btn {
            width: 100%;
            background: var(--blue-gradient);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
        }

        .notification-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-color);
            z-index: 1001;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .notification-panel.active {
            right: 0;
        }

        .notification-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: var(--bg-secondary);
        }

        .notification-item.unread {
            background: rgba(59, 130, 246, 0.05);
            border-left: 3px solid var(--blue-primary);
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 2rem 0;
            z-index: 50;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--bg-primary);
            color: var(--blue-primary);
            border-left-color: var(--blue-primary);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Adjust main content for sidebar */
        .dashboard-container {
            padding-left: 280px;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .dashboard-container {
                padding-left: 0;
            }

            .dashboard-header {
                padding: 1rem;
            }

            .dashboard-main {
                padding: 1rem;
            }

            .dashboard-welcome h1 {
                font-size: 2rem;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .students-grid {
                grid-template-columns: 1fr;
            }

            .notification-panel {
                width: 100%;
                right: -100%;
            }

            /* Mobile-specific proctoring section adjustments */
            #proctorAssignmentSection {
                padding: 1rem;
                border-radius: 12px;
            }

            .proctoring-card {
                padding: 1rem;
                border-radius: 12px;
            }

            .student-profile-section {
                gap: 12px;
                padding: 12px;
                margin-bottom: 16px;
                flex-direction: column;
                text-align: center;
            }

            .student-profile-picture {
                width: 60px;
                height: 60px;
            }

            #proctorStudentDetails {
                gap: 8px;
                margin-top: 12px;
            }

            #proctorStudentDetails > div {
                padding: 10px 12px;
                gap: 12px;
            }

            .exam-date-info {
                padding: 16px;
                margin-top: 16px;
                font-size: 0.95rem;
            }

            #proctorAssignmentSection .section-header {
                margin-bottom: 16px;
            }

            #proctorAssignmentSection .section-title {
                font-size: 1.5rem;
            }
        }

        /* Enhanced Modern Proctoring Assignment Section */
        #proctorAssignmentSection {
            background: linear-gradient(135deg, 
                rgba(59, 130, 246, 0.03) 0%, 
                rgba(147, 197, 253, 0.08) 25%,
                rgba(99, 102, 241, 0.05) 50%,
                rgba(59, 130, 246, 0.03) 100%);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid rgba(59, 130, 246, 0.15);
            box-shadow: 
                0 20px 25px -5px rgba(59, 130, 246, 0.08),
                0 10px 10px -5px rgba(59, 130, 246, 0.04),
                0 0 0 1px rgba(59, 130, 246, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        #proctorAssignmentSection::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, 
                var(--blue-primary), 
                #8b5cf6, 
                #06b6d4, 
                var(--blue-primary));
            background-size: 300% 100%;
            animation: gradientFlow 4s ease-in-out infinite;
        }

        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        #proctorAssignmentSection::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(59, 130, 246, 0.02) 60deg,
                transparent 120deg
            );
            animation: rotate 20s linear infinite;
            pointer-events: none;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #proctorAssignmentSection:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: 
                0 32px 64px -12px rgba(59, 130, 246, 0.15),
                0 20px 25px -5px rgba(59, 130, 246, 0.1),
                0 0 0 1px rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.25);
        }

        .proctoring-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.05),
                0 0 0 1px rgba(59, 130, 246, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        [data-theme="dark"] .proctoring-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .proctoring-card:hover {
            box-shadow: 
                0 32px 64px -12px rgba(59, 130, 246, 0.1),
                0 25px 50px -12px rgba(0, 0, 0, 0.08);
            transform: translateY(-4px);
        }

        .student-profile-section {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, 
                rgba(59, 130, 246, 0.05) 0%, 
                rgba(147, 197, 253, 0.08) 50%,
                rgba(99, 102, 241, 0.05) 100%);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.15);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .student-profile-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent);
            transition: left 0.6s ease;
        }

        .student-profile-section:hover::before {
            left: 100%;
        }

        .student-profile-section:hover {
            background: linear-gradient(135deg, 
                rgba(59, 130, 246, 0.08) 0%, 
                rgba(147, 197, 253, 0.12) 50%,
                rgba(99, 102, 241, 0.08) 100%);
            border-color: rgba(59, 130, 246, 0.25);
            transform: translateY(-2px);
        }

        .student-profile-picture {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, 
                var(--blue-primary) 0%, 
                #8b5cf6 50%,
                #06b6d4 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 
                0 20px 25px -5px rgba(59, 130, 246, 0.3),
                0 10px 10px -5px rgba(59, 130, 246, 0.2);
            border: 4px solid rgba(255, 255, 255, 0.8);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .student-profile-picture::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            padding: 4px;
            background: conic-gradient(
                from 0deg,
                var(--blue-primary),
                #8b5cf6,
                #06b6d4,
                var(--blue-primary)
            );
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: xor;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .student-profile-picture:hover::after {
            opacity: 1;
        }

        .student-profile-picture:hover {
            transform: scale(1.08) rotate(2deg);
            box-shadow: 
                0 25px 50px -12px rgba(59, 130, 246, 0.4),
                0 20px 25px -5px rgba(59, 130, 246, 0.3);
        }

        .student-profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .student-profile-picture .initials {
            font-size: 1.75rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .student-info {
            flex: 1;
        }

        .proctoring-card h3 {
            margin: 0 0 12px 0;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }

        .proctoring-card h3::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 30px;
            height: 2px;
            background: linear-gradient(90deg, var(--blue-primary), transparent);
            border-radius: 1px;
        }

        .proctoring-card .student-name {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.2;
            background: linear-gradient(135deg, var(--text-primary), var(--blue-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #proctorStudentEmail {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        #proctorStudentDetails {
            display: grid;
            gap: 12px;
            margin-top: 16px;
        }

        #proctorStudentDetails > div {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] #proctorStudentDetails > div {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        #proctorStudentDetails > div::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: linear-gradient(135deg, var(--blue-primary), #8b5cf6);
            transition: width 0.4s ease;
        }

        #proctorStudentDetails > div:hover {
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(59, 130, 246, 0.05);
            transform: translateX(8px);
            box-shadow: 
                0 10px 25px -5px rgba(59, 130, 246, 0.15),
                0 10px 10px -5px rgba(59, 130, 246, 0.05);
        }

        #proctorStudentDetails > div:hover::before {
            width: 5px;
        }

        #proctorStudentDetails i {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--blue-primary), #8b5cf6);
            color: white;
            border-radius: 8px;
            font-size: 0.9rem;
            flex-shrink: 0;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        #proctorStudentDetails span,
        #proctorStudentDetails a {
            font-size: 1rem;
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
        }

        #proctorStudentDetails a:hover {
            color: var(--blue-primary);
        }

        /* Enhanced Location Preview */
        .location-preview-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(59, 130, 246, 0.15);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s ease;
                        margin-top: 12px;
            box-shadow: 0 8px 25px -5px rgba(59, 130, 246, 0.1);
        }

        [data-theme="dark"] .location-preview-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .location-preview-card:hover {
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .map-preview {
            position: relative;
            height: 140px;
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .map-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .map-fallback {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #e5e7eb 0%, #f3f4f6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #6b7280;
        }

        .map-fallback i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .location-preview-card:hover .map-preview img {
            transform: scale(1.05);
        }

        .map-overlay {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .location-preview-card:hover .map-overlay {
            opacity: 1;
            transform: scale(1.1);
        }

        .location-info {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-text {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
        }

        .location-text i {
            background: linear-gradient(135deg, var(--blue-primary), #8b5cf6);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .directions-btn {
            background: linear-gradient(135deg, var(--blue-primary), #8b5cf6);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        .directions-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }

        .location-unavailable {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 20px;
            background: rgba(156, 163, 175, 0.1);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: 12px;
            border: 1px dashed rgba(156, 163, 175, 0.3);
        }

        .exam-date-info {
            background: linear-gradient(135deg, 
                rgba(59, 130, 246, 0.1) 0%, 
                rgba(147, 197, 253, 0.15) 50%,
                rgba(99, 102, 241, 0.1) 100%);
            border: 2px solid rgba(59, 130, 246, 0.25);
            border-radius: 16px;
            padding: 24px;
            margin-top: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--blue-primary);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
        }

        .exam-date-info::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                var(--blue-primary), 
                #8b5cf6, 
                #06b6d4, 
                var(--blue-primary));
            background-size: 300% 100%;
            animation: gradientFlow 3s ease-in-out infinite;
        }

        .exam-date-info:hover {
            background: linear-gradient(135deg, 
                rgba(59, 130, 246, 0.15) 0%, 
                rgba(147, 197, 253, 0.2) 50%,
                rgba(99, 102, 241, 0.15) 100%);
            border-color: rgba(59, 130, 246, 0.35);
            transform: scale(1.02);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.2);
        }

        .exam-date-info i {
            font-size: 1.3rem;
            animation: pulse 2.5s ease-in-out infinite;
        }

        /* Enhanced section header */
        #proctorAssignmentSection .section-header {
            background: none;
            padding: 0;
            margin-bottom: 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }

        #proctorAssignmentSection .section-title {
            background: linear-gradient(135deg, 
                var(--blue-primary) 0%, 
                #8b5cf6 30%,
                #06b6d4 60%,
                var(--blue-primary) 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 16px;
            animation: gradientShift 4s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        #proctorAssignmentSection .section-title i {
            background: linear-gradient(135deg, var(--blue-primary), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.75rem;
            animation: iconPulse 3s ease-in-out infinite;
        }

        @keyframes iconPulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1); 
            }
            50% { 
                opacity: 0.8; 
                transform: scale(1.1); 
            }
        }

        /* Enhanced upload button */
        #proctorAssignmentSection .add-student-btn {
            background: linear-gradient(135deg, 
                var(--blue-primary) 0%, 
                #8b5cf6 50%,
                #06b6d4 100%);
            background-size: 200% 200%;
            color: white;
            font-weight: 700;
            border-radius: 12px;
            padding: 14px 28px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 10px 25px -5px rgba(59, 130, 246, 0.4),
                0 10px 10px -5px rgba(59, 130, 246, 0.2);
            position: relative;
            overflow: hidden;
            border: none;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }

        #proctorAssignmentSection .add-student-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.25), 
                transparent);
            transition: left 0.6s ease;
        }

        #proctorAssignmentSection .add-student-btn:hover {
            background-position: 100% 0%;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 20px 25px -5px rgba(59, 130, 246, 0.5),
                0 10px 10px -5px rgba(59, 130, 246, 0.3);
        }

        #proctorAssignmentSection .add-student-btn:hover::before {
            left: 100%;
        }

        #proctorAssignmentSection .add-student-btn:active {
            transform: translateY(-1px) scale(0.98);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="header-left">
                <div class="profile-section" onclick="window.location.href='../pages/profile.html'">
                    <div class="profile-picture" id="profilePicture">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="tutor-name" id="tutorName">Loading...</div>
                </div>
            </div>
            <div class="header-right">
                <button class="notification-btn" onclick="window.location.href='../dashboards-sections/tutor/notifications.html'">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </button>
                <button id="theme-toggle" class="theme-toggle-btn" aria-label="Toggle Theme">
                    <div class="theme-icons">
                        <span class="theme-icon light material-symbols-outlined">light_mode</span>
                        <span class="theme-icon dark material-symbols-outlined">dark_mode</span>
                    </div>
                </button>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </header>

        <main class="dashboard-main">
            <div class="dashboard-welcome">
                <h1>Welcome back, <span id="welcomeName">Tutor</span>!</h1>
                <p>Manage your students and track their progress</p>
            </div>

            <div class="dashboard-content">
                <div class="content-section active" id="overview-section">
                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <div class="action-card" onclick="loadSection('evaluation')">
                            <div class="action-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <h3 class="action-title">Evaluation Center</h3>
                            <p class="action-description">Access evaluation assignments and evaluation page</p>
                        </div>

                        <div class="action-card" onclick="loadSection('student-management')">
                            <div class="action-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3 class="action-title">Student Management</h3>
                            <p class="action-description">Manage your students and track their progress</p>
                        </div>

                        <div class="action-card" onclick="loadSection('notifications')">
                            <div class="action-icon">
                                <i class="fas fa-bell"></i>
                            </div>
                            <h3 class="action-title">Notifications</h3>
                            <p class="action-description">View important updates and messages</p>
                        </div>

                        <div class="action-card" onclick="loadSection('proctor-upload')">
                            <div class="action-icon">
                                <i class="fas fa-upload"></i>
                            </div>
                            <h3 class="action-title">Proctor Upload</h3>
                            <p class="action-description">Upload proctoring data and manage assignments</p>
                        </div>
                    </div>
                </div>

                <div class="content-section" id="student-management-section">
                    <!-- Student Management Content will be loaded here -->
                </div>

                <div class="content-section" id="evaluation-section">
                    <!-- Evaluation Content will be loaded here -->
                </div>

                <div class="content-section" id="notifications-section">
                    <!-- Notifications Content will be loaded here -->
                </div>

                <div class="content-section" id="proctor-upload-section">
                    <!-- Proctor Upload Content will be loaded here -->
                </div>
            </div>

            <!-- Proctoring Assignment Section -->
            <div id="proctorAssignmentSection" class="students-section" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-eye" style="color: var(--primary-color); margin-right: 10px;"></i>
                        Proctoring Assignment
                    </h2>
                    <button class="add-student-btn" onclick="window.location.href='../dashboards-sections/tutor/proctor-upload.html'">
                        <i class="fas fa-upload"></i>
                        Upload Proctor Data
                    </button>
                </div>
                <div class="proctoring-card">
                    <div class="proctoring-card-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="student-profile-section">
                        <div class="student-profile-picture" id="proctorStudentProfilePicture">
                            <div class="initials">?</div>
                        </div>
                        <div class="student-info">
                            <h3>Assigned Student</h3>
                            <div id="proctorStudentName" class="student-name">Loading...</div>
                            <div id="proctorStudentEmail" style="font-size: 1.1rem; opacity: 0.95; margin-bottom: 10px;">Loading...</div>
                        </div>
                    </div>
                    <div id="proctorStudentDetails">
                        <div>
                            <i class="fas fa-phone"></i>
                            <span id="proctorStudentPhone">Loading...</span>
                        </div>
                        <div id="proctorStudentLocationContainer" style="grid-column: 1 / -1;">
                            <div id="proctorStudentLocation">Loading Location...</div>
                        </div>
                    </div>
                    <div class="exam-date-info">
                        <i class="fas fa-calendar-alt"></i>
                        <span id="proctorExamDate">iCup Week Assignment</span>
                    </div>
                </div>
            </div>

            <div class="students-section">
                <div class="section-header">
                    <h2 class="section-title">My Students</h2>
                    <button class="add-student-btn" onclick="showAddStudentModal()">
                        <i class="fas fa-plus"></i>
                        Add Student
                    </button>
                </div>
                <div class="students-grid" id="studentsGrid">
                    <!-- Students will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Add Student Modal -->
    <div class="modal" id="addStudentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Student</h3>
                <button class="close-btn" onclick="hideAddStudentModal()">&times;</button>
            </div>
            <form id="addStudentForm">
                <div class="form-group">
                    <label for="studentEmail">Student Email</label>
                    <input type="email" id="studentEmail" required>
                </div>
                <div class="form-group">
                    <label for="studentName">Student Name</label>
                    <input type="text" id="studentName" required>
                </div>
                <div class="form-group">
                    <label for="studentInstitution">Institution</label>
                    <input type="text" id="studentInstitution" required>
                </div>
                <div class="form-group">
                    <label for="studentBatch">Batch</label>
                    <input type="text" id="studentBatch" required>
                </div>
                <button type="submit" class="submit-btn">Send Invitation</button>
            </form>
        </div>
    </div>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <h3>Notifications</h3>
            <button class="close-btn" onclick="toggleNotifications()">&times;</button>
        </div>
        <div id="notificationsList">
            <!-- Notifications will be loaded here -->
        </div>
    </div>

    <script src="../js/supabase-config.js"></script>
    <script src="../js/api/user.js"></script>
    <script src="../js/api/exam.js"></script>
    <script src="../js/api/proctor.js"></script>
    <script src="../js/api/evaluation.js"></script>
    <script src="../js/api/payment.js"></script>
    <script src="../js/backend-init.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Only load theme.js if not already loaded
        if (!window.ThemeManager && !document.querySelector('script[src="../js/theme.js"]')) {
            const themeScript = document.createElement('script');
            themeScript.src = '../js/theme.js';
            themeScript.onload = function() {
                console.log('Theme script loaded successfully');
            };
            themeScript.onerror = function() {
                console.error('Failed to load theme script');
            };
            document.head.appendChild(themeScript);
        }
    </script>
    <script>
        let currentUser = null;
        let notifications = [];
        let currentExam = null;

        // Load tutor profile and data
        async function loadTutorProfile() {
            try {
                await window.waitForBackend();

                // Check Supabase auth session first
                const { data: { session }, error } = await window.supabaseClient.auth.getSession();

                if (error || !session || !session.user) {
                    console.log('No valid session found, redirecting to login');
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('userData');
                    localStorage.removeItem('userProfile');
                    window.location.href = '../auth/login.html';
                    return;
                }

                // Check if user is logged in using localStorage
                if (!localStorage.getItem('isLoggedIn') || localStorage.getItem('isLoggedIn') !== 'true') {
                    console.log('No localStorage session, redirecting to login');
                    window.location.href = '../auth/login.html';
                    return;
                }

                // Get fresh user data from backend
                const backendUser = await window.userAPI.getCurrentUser();

                if (!backendUser || !backendUser.profile || backendUser.profile.role !== 'tutor') {
                    console.log('Invalid user profile or not a tutor, redirecting to login');
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('userData');
                    localStorage.removeItem('userProfile');
                    window.location.href = '../auth/login.html';
                    return;
                }

                // Use fresh data from backend
                currentUser = {
                    ...backendUser.user,
                    ...backendUser.profile,
                    fullName: backendUser.profile.full_name || backendUser.profile.fullName
                };

                // Update profile display
                const displayName = currentUser.fullName || currentUser.full_name || 'Tutor';
                document.getElementById('tutorName').textContent = displayName;
                document.getElementById('welcomeName').textContent = displayName;

                // Update profile picture with latest data
                const profilePicEl = document.getElementById('profilePicture');
                if (currentUser.profile_picture) {
                    profilePicEl.innerHTML = `<img src="${currentUser.profile_picture}" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                } else {
                    profilePicEl.innerHTML = `<span>${displayName.charAt(0).toUpperCase()}</span>`;
                }

                // Load current exam first
                const examResult = await window.examAPI.getCurrentExam();
                currentExam = examResult.success ? examResult.data : null;

                // Load students, notifications, and proctoring assignments
                await loadStudents();
                await loadNotifications();
                await loadProctorAssignment();
            } catch (error) {
                console.error('Error loading tutor profile:', error);
                // Fallback to localStorage if backend fails
                try {
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');

                    if (userProfile.role !== 'tutor') {
                        window.location.href = '../auth/login.html';
                        return;
                    }

                    const displayName = userProfile.full_name || userData.full_name || 'Tutor';
                    document.getElementById('tutorName').textContent = displayName;
                    document.getElementById('welcomeName').textContent = displayName;

                    const profilePicEl = document.getElementById('profilePicture');
                    if (userProfile.profile_picture) {
                        profilePicEl.innerHTML = `<img src="${userProfile.profile_picture}" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    } else {
                        profilePicEl.innerHTML = `<span>${displayName.charAt(0).toUpperCase()}</span>`;
                    }
                } catch (fallbackError) {
                    console.error('Fallback error:', fallbackError);
                }
            }
        }

        // Load students (Connected Students)
        async function loadStudents() {
            try {
                if (!currentUser) {
                    console.log('No current user, skipping students load');
                    return;
                }

                const userId = currentUser.user_id || currentUser.id;
                console.log('Loading students for tutor:', userId);

                // Fetch the connected students from the API
                const connectedStudents = await window.userAPI.getConnectedStudents(userId);
                console.log('Connected students:', connectedStudents);

                // Get current exam to check enrollment status - ensure we have the data
                const currentExamResult = await window.examAPI.getCurrentExam();
                const currentExam = currentExamResult.success ? currentExamResult.data : null;

                console.log('Current exam for enrollment check:', currentExam);

                if (!currentExam) {
                    console.log('No current exam available');
                }

                const studentsGrid = document.getElementById('studentsGrid');

                if (connectedStudents.length === 0) {
                    studentsGrid.innerHTML = `
                        <div class="no-students">
                            <i class="fas fa-users" style="font-size: 2rem; opacity: 0.5; margin-bottom: 1rem;"></i>
                            <p>No connected students yet</p>
                            <small>Students will appear here once they register and connect with you</small>
                            <button onclick="window.location.href='../dashboards-sections/tutor/notifications.html'" class="view-notifications-btn" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--blue-primary); color: white; border: none; border-radius: var(--radius-md); cursor: pointer;">
                                View Notifications
                            </button>
                        </div>
                    `;
                    return;
                }

                // Check enrollment status for each student using the latest exam
                const studentsWithEnrollment = await Promise.all(
                    connectedStudents.map(async (student) => {
                        let isEnrolled = false;
                        try {
                            if (!currentExam) {
                                console.log('No current exam available');
                                return { ...student, isEnrolled: false };
                            }

                            // Check directly in student_enrollment table like student dashboard does
                            const { data: enrollmentData, error: enrollmentError } = await window.supabaseClient
                                .from('student_enrollment')
                                .select('*')
                                .eq('user_id', student.user_id)
                                .eq('week_number', currentExam.week_number)
                                .eq('enrolled', true);

                            if (enrollmentError) {
                                console.error('Error checking enrollment for student:', student.user_id, enrollmentError);
                                isEnrolled = false;
                            } else {
                                isEnrolled = enrollmentData && enrollmentData.length > 0;
                                console.log('Enrollment check result for', student.full_name, ':', {
                                    weekNumber: currentExam.week_number,
                                    userId: student.user_id,
                                    enrollmentData: enrollmentData,
                                    isEnrolled: isEnrolled
                                });
                            }

                        } catch (error) {
                            console.error('Error checking enrollment for student:', student.user_id, error);

                            // Fallback: try using exam API method
                            try {
                                console.log('Trying fallback enrollment check via exam API');
                                isEnrolled = await window.examAPI.isStudentEnrolledInLatestExam(student.user_id);
                                console.log('Fallback enrollment result:', isEnrolled);
                            } catch (fallbackError) {
                                console.error('Fallback enrollment check failed:', fallbackError);
                                isEnrolled = false;
                            }
                        }

                        console.log('Final enrollment status for', student.full_name, ':', isEnrolled);
                        return {
                            ...student,
                            isEnrolled
                        };
                    })
                );

                studentsGrid.innerHTML = studentsWithEnrollment.map(student => `
                    <div class="student-card">
                        <div class="student-header">
                            <div class="student-avatar">
                                ${student.profile_picture 
                                    ? `<img src="${student.profile_picture}" alt="${student.full_name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` 
                                    : student.full_name.charAt(0).toUpperCase()
                                }
                            </div>
                            <div class="student-info">
                                <h3>${student.full_name}</h3>
                                <p>${student.email}</p>
                                <div class="enrollment-status" style="margin-top: 0.5rem;">
                                    ${student.isEnrolled 
                                        ? '<span style="color: var(--green-primary); font-size: 0.875rem; display: flex; align-items: center; gap: 0.25rem;"><i class="fas fa-check-circle"></i> Enrolled in iCup</span>'
                                        : '<span style="color: var(--orange-primary); font-size: 0.875rem; display: flex; align-items: center; gap: 0.25rem;"><i class="fas fa-exclamation-circle"></i> Not Enrolled</span>'
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="student-actions">
                            ${!student.isEnrolled && currentExam ? `
                                <button class="enroll-student-btn" onclick="enrollStudent('${student.user_id}', '${student.full_name}')" style="background: var(--blue-primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius-md); cursor: pointer; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; margin-right: 0.5rem;">
                                    <i class="fas fa-plus"></i>
                                    Enroll Student
                                </button>
                            ` : ''}
                            <button class="remove-student-btn" onclick="removeStudent('${student.user_id}', '${student.full_name}')">
                                <i class="fas fa-trash"></i>
                                Remove
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading students:', error);
                const studentsGrid = document.getElementById('studentsGrid');
                studentsGrid.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle" style="color: var(--red-primary); font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Error loading students</p>
                        <button onclick="loadStudents()" class="retry-btn">Try Again</button>
                    </div>
                `;
            }
        }

        // Redirect to payment page for student enrollment
        async function enrollStudent(studentId, studentName) {
            try {
                // Get current exam information
                const examResult = await window.examAPI.getCurrentExamForPayment();
                if (!examResult.success || !examResult.data) {
                    alert('No current exam available for enrollment.');
                    return;
                }

                // Redirect to tutor payment page with student and exam information
                const params = new URLSearchParams({
                    studentId: studentId,
                    studentName: studentName,
                    examId: examResult.data.exam_id,
                    weekNumber: examResult.data.week_number
                });

                window.location.href = `../pages/tutor-icup-payment.html?${params.toString()}`;
            } catch (error) {
                console.error('Error preparing enrollment:', error);
                alert('Failed to prepare enrollment. Please try again.');
            }
        }

        // Remove student from tutor's list
        async function removeStudent(studentId, studentName) {
            if (!confirm(`Are you sure you want to remove ${studentName} from your students list?`)) {
                return;
            }

            try {
                const userId = currentUser.user_id || currentUser.id;

                // Remove student from tutor's students list
                const { data: tutorInfo, error: fetchError } = await window.supabaseClient
                    .from('tutor_additional_info')
                    .select('students')
                    .eq('user_id', userId)
                    .single();

                if (fetchError && fetchError.code !== 'PGRST116') {
                    throw fetchError;
                }

                const currentStudents = tutorInfo?.students || [];
                const updatedStudents = currentStudents.filter(id => id !== studentId);

                const { error: updateError } = await window.supabaseClient
                    .from('tutor_additional_info')
                    .update({ students: updatedStudents })
                    .eq('user_id', userId);

                if (updateError) throw updateError;

                // Remove tutor from student's tutors list
                const { data: studentInfo, error: studentFetchError } = await window.supabaseClient
                    .from('student_additional_info')
                    .select('tutors')
                    .eq('user_id', studentId)
                    .single();

                if (studentFetchError && studentFetchError.code !== 'PGRST116') {
                    throw studentFetchError;
                }

                const currentTutors = studentInfo?.tutors || [];
                const updatedTutors = currentTutors.filter(id => id !== userId);

                const { error: studentUpdateError } = await window.supabaseClient
                    .from('student_additional_info')
                    .update({ tutors: updatedTutors })
                    .eq('user_id', studentId);

                if (studentUpdateError) throw studentUpdateError;

                // Reload the students list
                await loadStudents();

                alert(`${studentName} has been removed from your students list.`);

            } catch (error) {
                console.error('Error removing student:', error);
                alert('Failed to remove student. Please try again.');
            }
        }

        // Accept student request
        async function acceptStudentRequest(studentId) {
            try {
                // Call API to accept student request
                console.log(`Accepting student request for student ID: ${studentId}`);
                // await window.userAPI.acceptStudentRequest(studentId);

                // Remove the student from the list of pending requests
                const studentsGrid = document.getElementById('studentsGrid');
                studentsGrid.innerHTML = ''; // Refresh the student list

                // Reload students and notifications
                await loadStudents();
                await loadNotifications();
                await loadConnectedStudents();

            } catch (error) {
                console.error('Error accepting student request:', error);
                alert('Failed to accept student request. Please try again.');
            }
        }

         // Reject student request
        async function rejectStudentRequest(studentId) {
            try {
                // Call API to reject student request
                console.log(`Rejecting student request for student ID: ${studentId}`);
                // await window.userAPI.rejectStudentRequest(studentId);

                // Remove the student from the list of pending requests
                const studentsGrid = document.getElementById('studentsGrid');
                studentsGrid.innerHTML = ''; // Refresh the student list

                // Reload students and notifications
                await loadStudents();
                await loadNotifications();

            } catch (error) {
                console.error('Error rejecting student request:', error);
                alert('Failed to reject student request. Please try again.');
            }
        }

        // Load notifications
        async function loadNotifications() {
            try {
                if (!currentUser) {
                    console.log('No currentuser, skipping notifications load');
                                        return;
                }

                // Get real notifications from database (only visible ones)
                const { data: dbNotifications, error } = await window.supabaseClient
                    .from('notifications')
                    .select('*')
                    .eq('user_id', currentUser.user_id || currentUser.id)
                    .eq('hidden', false)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error fetching notifications:', error);
                    notifications = [];
                } else {
                    // Convert database notifications to the format expected by the UI
                    notifications = (dbNotifications || []).map(notif => ({
                        id: notif.id,
                        type: notif.type,
                        title: notif.title,
                        message: notif.message,
                        timestamp: new Date(notif.created_at),
                        studentId: notif.related_user_id,
                        unread: !notif.read
                    }));
                }

                updateNotificationBadge();
                renderNotifications();
            } catch (error) {
                console.error('Error loading notifications:', error);
                notifications = [];
                updateNotificationBadge();
                renderNotifications();
            }
        }



        // Render notifications
        function renderNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = notifications.map(notification => `
                <div class="notification-item ${notification.unread ? 'unread' : ''}" onclick="markAsRead(${notification.id})">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <i class="fas ${getNotificationIcon(notification.type)}" style="color: var(--blue-primary);"></i>
                        <strong style="color: var(--text-primary);">${notification.title}</strong>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">${notification.message}</p>
                    <small style="color: var(--text-muted);">${formatTime(notification.timestamp)}</small>
                    ${notification.type === 'student_request' ? `<button onclick="acceptStudentRequest(${notification.studentId})">Accept</button> <button onclick="rejectStudentRequest(${notification.studentId})">Reject</button>` : ''}
                </div>
            `).join('');
        }

        // Get notification icon
        function getNotificationIcon(type) {
            switch (type) {
                case 'student_request': return 'fa-user-plus';
                case 'exam_submitted': return 'fa-file-alt';
                case 'evaluation_due': return 'fa-clock';
                default: return 'fa-bell';
            }
        }

        // Format time
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / (1000 * 60 * 60));

            if (hours < 1) return 'Just now';
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        // Toggle notifications panel
        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('active');
        }

        // Mark notification as read
        function markAsRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.unread = false;
                updateNotificationBadge();
                renderNotifications();
            }
        }

        // Show add student modal
        function showAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'block';
        }

        // Hide add student modal
        function hideAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'none';
            document.getElementById('addStudentForm').reset();
        }

        // Handle add student form submission
        document.getElementById('addStudentForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                email: document.getElementById('studentEmail').value,
                name: document.getElementById('studentName').value,
                institution: document.getElementById('studentInstitution').value,
                batch: document.getElementById('studentBatch').value
            };

            try {
                // Here you would call your API to send student invitation
                console.log('Sending invitation to:', formData);

                // Mock success
                alert('Student invitation sent successfully!');
                hideAddStudentModal();

                // Add to notifications
                notifications.unshift({
                    id: Date.now(),
                    type: 'student_request',
                    title: 'Invitation Sent',
                    message: `Invitation sent to ${formData.name}`,
                    timestamp: new Date(),
                    unread: true
                });

                updateNotificationBadge();
                renderNotifications();

            } catch (error) {
                console.error('Error sending invitation:', error);
                alert('Failed to send invitation. Please try again.');
            }
        });

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear localStorage
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userData');
                localStorage.removeItem('userProfile');

                // Redirect to login
                window.location.href = '../auth/login.html';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('addStudentModal');
            if (event.target === modal) {
                hideAddStudentModal();
            }
        }

        // Update notification badge count
        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => n.unread).length;
            const badge = document.getElementById('notificationBadge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }

            // Update localStorage
            localStorage.setItem('notificationCount', unreadCount.toString());
        }

        // Refresh notification badge from server
        async function refreshNotificationBadge() {
            try {
                if (!currentUser) return;

                const userId = currentUser.user_id || currentUser.id;
                const { data: visibleNotifications, error } = await window.supabaseClient
                    .from('notifications')
                    .select('id')
                    .eq('user_id', userId)
                    .eq('hidden', false);

                if (!error) {
                    const count = visibleNotifications ? visibleNotifications.length : 0;
                    const badge = document.getElementById('notificationBadge');

                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }

                    // Update localStorage with the actual count
                    localStorage.setItem('notificationCount', count.toString());

                    // Update local notifications array if it exists
                    if (typeof notifications !== 'undefined') {
                        notifications = notifications.filter(n => n.id !== 'removed');
                    }
                }
            } catch (error) {
                console.error('Error refreshing notification badge:', error);
            }
        }

        // Listen for notification removal events
        window.addEventListener('notificationRemoved', function(event) {
            const newCount = event.detail.newCount;
            const badge = document.getElementById('notificationBadge');
            if (newCount > 0) {
                badge.textContent = newCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }

            // Also refresh from database to ensure accuracy
            setTimeout(() => {
                refreshNotificationBadge();
            }, 1000);
        });

        // Listen for storage changes (cross-tab sync)
        window.addEventListener('storage', function(event) {
            if (event.key === 'notificationCount') {
                const count = parseInt(event.newValue || '0');
                const badge = document.getElementById('notificationBadge');
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        });

        // Focus event to refresh badge when user returns to dashboard
        window.addEventListener('focus', function() {
            refreshNotificationBadge();
        });

        // Load proctor assignment
        async function loadProctorAssignment() {
            try {
                if (!currentUser || !currentExam) {
                    console.log('No current user or exam, skipping proctor assignment load');
                    return;
                }

                const userId = currentUser.user_id || currentUser.id;
                console.log('Loading proctor assignment for tutor:', userId);

                // Get proctor assignment using proctor_id
                const { data: proctorAssignment, error } = await window.supabaseClient
                    .from('proctor_allocation')
                    .select('*')
                    .eq('proctor_id', userId) // Use proctor_id to find the assignment
                    .eq('week_number', currentExam.week_number)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading proctor assignment:', error);
                    return;
                }

                if (proctorAssignment) {
                    // Show the proctoring assignment section
                    const proctorSection = document.getElementById('proctorAssignmentSection');
                    const studentNameEl = document.getElementById('proctorStudentName');
                    const studentDetailsEl = document.getElementById('proctorStudentDetails');
                    const studentEmailEl = document.getElementById('proctorStudentEmail');
                    const examDateEl = document.getElementById('proctorExamDate');
                    const studentPhoneEl = document.getElementById('proctorStudentPhone');
                    const studentLocationEl = document.getElementById('proctorStudentLocation');
                    const studentProfilePictureEl = document.getElementById('proctorStudentProfilePicture');

                    if (proctorSection && studentNameEl && studentDetailsEl && studentEmailEl && examDateEl && studentPhoneEl && studentLocationEl && studentProfilePictureEl) {
                        studentNameEl.textContent = proctorAssignment.student_full_name;

                        // Get student details from user_information table (including profile picture)
                        console.log('Fetching student data for ID:', proctorAssignment.student_id);
                        const { data: studentData, error: studentError } = await window.supabaseClient
                            .from('user_information')
                            .select('email, phone, profile_picture, full_name')
                            .eq('user_id', proctorAssignment.student_id)
                            .single();

                        if (studentError) {
                            console.error('Student data fetch error:', studentError);
                        } else {
                            console.log('Student data fetched:', studentData);
                        }

                        // Set student profile picture
                        if (!studentError && studentData) {
                            if (studentData.profile_picture) {
                                studentProfilePictureEl.innerHTML = `<img src="${studentData.profile_picture}" alt="${studentData.full_name || proctorAssignment.student_full_name}" />`;
                            } else {
                                const initials = (studentData.full_name || proctorAssignment.student_full_name)
                                    .split(' ')
                                    .map(name => name.charAt(0))
                                    .join('')
                                    .substring(0, 2)
                                    .toUpperCase();
                                studentProfilePictureEl.innerHTML = `<div class="initials">${initials}</div>`;
                            }
                        } else {
                            const initials = proctorAssignment.student_full_name
                                .split(' ')
                                .map(name => name.charAt(0))
                                .join('')
                                .substring(0, 2)
                                .toUpperCase();
                            studentProfilePictureEl.innerHTML = `<div class="initials">${initials}</div>`;
                        }

                        // Get student location from student_additional_info table
                        const { data: studentLocationData, error: locationError } = await window.supabaseClient
                            .from('student_additional_info')
                            .select('location_qr')
                            .eq('user_id', proctorAssignment.student_id)
                            .single();

                        // Set student phone number
                        if (!studentError && studentData && studentData.phone) {
                            studentPhoneEl.textContent = studentData.phone;
                        } else {
                            studentPhoneEl.textContent = 'Not Available';
                        }

                        // Set student location with enhanced map preview
                        let googleMapsUrl = '#';
                        let locationText = 'Location Not Available';
                        let coordinates = null;

                        if (!locationError && studentLocationData && studentLocationData.location_qr) {
                            googleMapsUrl = studentLocationData.location_qr;
                            locationText = 'View on Google Maps';

                            // Extract coordinates from various Google Maps URL formats
                            let coordMatch = googleMapsUrl.match(/q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                            if (!coordMatch) {
                                coordMatch = googleMapsUrl.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                            }
                            if (!coordMatch) {
                                coordMatch = googleMapsUrl.match(/ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                            }
                            if (!coordMatch) {
                                coordMatch = googleMapsUrl.match(/maps\/place\/[^\/]+\/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                            }

                            if (coordMatch) {
                                coordinates = {
                                    lat: parseFloat(coordMatch[1]),
                                    lng: parseFloat(coordMatch[2])
                                };
                            }
                        }

                        // Create enhanced location display
                        if (coordinates && !isNaN(coordinates.lat) && !isNaN(coordinates.lng)) {
                            // Create map preview using multiple fallback options
                            const createMapPreview = () => {
                                // Try OpenStreetMap first (no API key needed)
                                const osmUrl = `https://tile.openstreetmap.org/embed.html?bbox=${coordinates.lng-0.01},${coordinates.lat-0.01},${coordinates.lng+0.01},${coordinates.lat+0.01}&layer=mapnik&marker=${coordinates.lat},${coordinates.lng}`;

                                // Static map from OpenStreetMap tiles (most reliable)
                                const staticMapUrl = `https://api.mapbox.com/styles/v1/mapbox/streets-v11/static/pin-s-l+285A98(${coordinates.lng},${coordinates.lat})/${coordinates.lng},${coordinates.lat},14,0/300x200?access_token=pk.eyJ1IjoidGVzdCIsImEiOiJjazZhMWlpbjkwYjI1M29xa2VqcGVhNDg4In0.test`;

                                // Simple coordinate display as ultimate fallback
                                const coordinateDisplay = `
                                    <div style="background: linear-gradient(135deg, #e5e7eb 0%, #f3f4f6 100%); height: 140px; display: flex; align-items: center; justify-content: center; flex-direction: column; color: #6b7280;">
                                        <i class="fas fa-map-marker-alt" style="font-size: 2rem; margin-bottom: 0.5rem; color: #285A98;"></i>
                                        <div style="text-align: center; font-size: 0.9rem;">
                                            <div style="font-weight: 600; color: #374151;">Student Location</div>
                                            <div style="font-size: 0.8rem; margin-top: 0.25rem;">
                                                ${coordinates.lat.toFixed(4)}, ${coordinates.lng.toFixed(4)}
                                            </div>
                                        </div>
                                    </div>
                                `;

                                return coordinateDisplay; // Use coordinate display as it's most reliable
                            };

                            studentLocationEl.innerHTML = `
                                <div class="location-preview-card" onclick="window.open('${googleMapsUrl}', '_blank')">
                                    <div class="map-preview">
                                        ${createMapPreview()}
                                        <div class="map-overlay">
                                            <i class="fas fa-external-link-alt"></i>
                                        </div>
                                    </div>
                                    <div class="location-info">
                                        <div class="location-text">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span>Student Location</span>
                                        </div>
                                        <div class="directions-btn" onclick="event.stopPropagation(); window.open('https://www.google.com/maps/dir/?api=1&destination=${coordinates.lat},${coordinates.lng}', '_blank')">
                                            <i class="fas fa-directions"></i>
                                            Get Directions
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (googleMapsUrl !== '#') {
                            // If we have a Google Maps URL but can't extract coordinates
                            studentLocationEl.innerHTML = `
                                <div class="location-preview-card" onclick="window.open('${googleMapsUrl}', '_blank')">
                                    <div class="map-preview" style="background: linear-gradient(135deg, #e5e7eb 0%, #f3f4f6 100%); display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                        <i class="fas fa-map-marker-alt" style="font-size: 2rem; color: #6b7280; margin-bottom: 0.5rem;"></i>
                                        <span style="color: #6b7280; font-size: 0.9rem;">Location Available</span>
                                        <div class="map-overlay">
                                            <i class="fas fa-external-link-alt"></i>
                                        </div>
                                    </div>
                                    <div class="location-info">
                                        <div class="location-text">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span>View Student Location</span>
                                        </div>
                                        <div class="directions-btn" onclick="event.stopPropagation(); window.open('${googleMapsUrl}', '_blank')">
                                            <i class="fas fa-external-link-alt"></i>
                                            Open Maps
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            studentLocationEl.innerHTML = `
                                <div class="location-unavailable">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${locationText}</span>
                                </div>
                            `;
                        }

                        if (!studentError && studentData) {
                            studentEmailEl.textContent = studentData.email;
                        } else {
                            studentEmailEl.textContent = 'Student email not found';
                        }

                        examDateEl.textContent = `iCup Week ${currentExam.week_number} - ${new Date(currentExam.scheduled_at).toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}`;

                        proctorSection.style.display = 'block';
                    }
                } else {
                    console.log('No proctor assignment found for this tutor');
                }
            } catch (error) {
                console.error('Error loading proctor assignment:', error);
            }
        }

        // Section mappings for loading content
        const sectionMappings = {
            'student-management': '../dashboards-sections/tutor/student-setup.html',
            'notifications': '../dashboards-sections/tutor/notifications.html',
            'proctor-upload': '../dashboards-sections/tutor/proctor-upload.html'
        };

        // Function to load a specific section - define globally
        window.loadSection = function(sectionId) {
            // Hide all content sections
            const contentSections = document.querySelectorAll('.dashboard-content .content-section');
            contentSections.forEach(section => {
                section.classList.remove('active');
            });

            // Show the selected section
            const selectedSection = document.getElementById(sectionId + '-section');
            if (selectedSection) {
                selectedSection.classList.add('active');

                // Load content based on section id
                if (sectionId === 'evaluation') {
                    fetch('../dashboards-sections/tutor/evaluation.html')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.text();
                        })
                        .then(data => {
                            console.log('Evaluation section data loaded successfully');

                            // Parse the HTML content
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(data, 'text/html');

                            // Get all content from the body
                            const bodyContent = doc.body.innerHTML;
                            selectedSection.innerHTML = bodyContent;

                            // Execute scripts from the loaded content
                            const scripts = doc.querySelectorAll('script');
                            scripts.forEach(script => {
                                try {
                                    const newScript = document.createElement('script');
                                    if (script.src) {
                                        newScript.src = script.src;
                                    } else {
                                        newScript.textContent = script.textContent;
                                    }
                                    document.head.appendChild(newScript);

                                    // Remove after a short delay to allow execution
                                    setTimeout(() => {
                                        if (newScript.parentNode) {
                                            newScript.parentNode.removeChild(newScript);
                                        }
                                    }, 100);
                                } catch (scriptError) {
                                    console.error('Error executing script:', scriptError);
                                }
                            });

                            // Wait a moment for scripts to load, then initialize
                            setTimeout(() => {
                                try {
                                    if (typeof window.initializeTutorEvaluation === 'function') {
                                        console.log('Initializing tutor evaluation...');
                                        window.initializeTutorEvaluation();
                                    } else {
                                        console.log('initializeTutorEvaluation function not found, retrying...');
                                        // Try again after a longer delay
                                        setTimeout(() => {
                                            if (typeof window.initializeTutorEvaluation === 'function') {
                                                window.initializeTutorEvaluation();
                                            } else {
                                                console.error('initializeTutorEvaluation function still not available');
                                            }
                                        }, 500);
                                    }
                                } catch (initError) {
                                    console.error('Error initializing evaluation section:', initError);
                                }
                            }, 200);
                        })
                        .catch(error => {
                            console.error('Error loading evaluation section:', error);
                            selectedSection.innerHTML = `
                                <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--red-primary); margin-bottom: 1rem;"></i>
                                    <h3>Failed to load evaluation content</h3>
                                    <p>Error: ${error.message}</p>
                                    <button onclick="loadSection('evaluation')" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--blue-primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Try Again
                                    </button>
                                </div>
                            `;
                        });
                } else if (sectionMappings[sectionId]) {
                    fetch(sectionMappings[sectionId])
                        .then(response => response.text())
                        .then(data => {
                            selectedSection.innerHTML = data;
                        })
                        .catch(error => {
                            console.error('Error loading section:', error);
                            selectedSection.innerHTML = '<p>Failed to load content.</p>';
                        });
                } else if (sectionId === 'overview') {
                    // Overview section content is already in the HTML
                } else {
                    selectedSection.innerHTML = '<p>Section content coming soon...</p>';
                }
            } else {
                console.error('Section not found:', sectionId);
            }

            // Remove 'active' class from all nav items
            const navItems = document.querySelectorAll('.sidebar .nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });

            // Add 'active' class to the clicked nav item
            const clickedNavItem = document.querySelector(`.sidebar .nav-item[onclick="loadSection('${sectionId}')"]`);
            if (clickedNavItem) {
                clickedNavItem.classList.add('active');
            }
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            window.waitForBackend().then(() => {
                loadTutorProfile();
            });
        });

        // Add message listener for iframe navigation
        window.addEventListener('message', function(event) {
            // Verify origin for security
            if (event.data && event.data.type === 'navigate' && event.data.url) {
                try {
                    // Navigate to the evaluation page
                    window.location.href = event.data.url;
                } catch (error) {
                    console.error('Navigation error:', error);
                    // Fallback: open in new tab
                    window.open(event.data.url, '_blank');
                }
            }
        });
    </script>

    <!-- Sidebar -->
    <div class="sidebar">
        <a href="#" class="nav-item active" onclick="loadSection('overview')">
            <i class="fas fa-home"></i>
            <span>Overview</span>
        </a>

        <a href="#" class="nav-item" onclick="loadSection('student-management')">
            <i class="fas fa-users"></i>
            <span>Student Management</span>
        </a>

        <a href="#" class="nav-item" onclick="loadSection('evaluation')">
            <i class="fas fa-clipboard-check"></i>
            <span>Evaluation</span>
        </a>

        <a href="#" class="nav-item" onclick="loadSection('notifications')">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
        </a>
    </div>
</body>
</html>