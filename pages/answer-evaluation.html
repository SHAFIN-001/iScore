
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Answer Evaluation - iScore</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/theme.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .evaluation-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem;
        }

        .evaluation-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .evaluation-header h1 {
            color: #1a1a2e;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subject-selector {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .subject-card {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .subject-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }

        .subject-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .answer-set-selector {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .answer-set-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .answer-set-card {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .answer-set-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }

        .answer-set-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .evaluation-workspace {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .drawing-tools {
            display: flex;
            gap: 0.5rem;
        }

        .tool-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tool-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .tool-btn.active {
            background: #4c63d2;
            box-shadow: 0 4px 15px rgba(76, 99, 210, 0.4);
        }

        .navigation-controls {
            display: flex;
            gap: 0.5rem;
        }

        .nav-btn {
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            background: #6c757d;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover:not(:disabled) {
            background: #5a6268;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .image-viewer {
            position: relative;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 2rem;
            overflow: hidden;
            min-height: 600px;
        }

        .image-container {
            position: relative;
            width: 100%;
            height: 600px;
            overflow: auto;
        }

        .answer-image {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .annotation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: auto;
            cursor: crosshair;
        }

        .zoom-controls {
            display: flex;
            gap: 0.5rem;
        }

        .zoom-btn {
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            background: #28a745;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .zoom-btn:hover {
            background: #218838;
        }

        .evaluation-form {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            margin-top: 2rem;
        }

        .marks-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .marks-input {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .marks-input input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 100px;
        }

        .comments-section {
            margin-top: 1rem;
        }

        .comments-section textarea {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
        }

        .submit-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #ddd;
        }

        .submit-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            background: #28a745;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .save-progress-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            background: #ffc107;
            color: #212529;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .save-progress-btn:hover {
            background: #e0a800;
        }

        .loading-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .loading-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #667eea;
        }

        .image-info {
            background: #e9ecef;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .anonymous-id {
            font-family: 'Courier New', monospace;
            background: #667eea;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .color-picker {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .color-option.active {
            transform: scale(1.2);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .red { background-color: #dc3545; }
        .blue { background-color: #007bff; }

        .progress-indicator {
            text-align: center;
            margin: 1rem 0;
            font-weight: 600;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .evaluation-container {
                padding: 0.5rem;
            }
            
            .toolbar {
                flex-direction: column;
                gap: 1rem;
            }
            
            .drawing-tools, .navigation-controls, .zoom-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .image-container {
                height: 400px;
            }
        }
    </style>
</head>

<body>
    <div class="evaluation-container">
        <!-- Header -->
        <div class="evaluation-header">
            <h1><i class="fas fa-clipboard-check"></i> Answer Evaluation System</h1>
            <p>Evaluate student answer sheets with precision and maintain anonymity</p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state">
            <i class="fas fa-spinner fa-spin"></i>
            <h3>Loading Evaluation System...</h3>
            <p>Please wait while we load your assigned evaluations</p>
        </div>

        <!-- Subject Selector -->
        <div id="subjectSelector" class="subject-selector" style="display: none;">
            <h2><i class="fas fa-book"></i> Select Subject to Evaluate</h2>
            <div id="subjectGrid" class="subject-grid">
                <!-- Subjects will be loaded dynamically -->
            </div>
        </div>

        <!-- Answer Set Selector -->
        <div id="answerSetSelector" class="answer-set-selector" style="display: none;">
            <h2><i class="fas fa-file-alt"></i> Select Answer Set to Evaluate</h2>
            <p class="text-muted">Choose an answer set to begin evaluation. Student identities are kept anonymous.</p>
            <div id="answerSetGrid" class="answer-set-grid">
                <!-- Answer sets will be loaded dynamically -->
            </div>
        </div>

        <!-- Evaluation Workspace -->
        <div id="evaluationWorkspace" class="evaluation-workspace">
            <!-- Toolbar -->
            <div class="toolbar">
                <div class="drawing-tools">
                    <div class="color-picker">
                        <span>Pen Color:</span>
                        <div class="color-option red active" data-color="#dc3545"></div>
                        <div class="color-option blue" data-color="#007bff"></div>
                    </div>
                    <button class="tool-btn active" id="penTool" data-tool="pen">
                        <i class="fas fa-pen"></i> Pen
                    </button>
                    <button class="tool-btn" id="eraserTool" data-tool="eraser">
                        <i class="fas fa-eraser"></i> Eraser
                    </button>
                    <button class="tool-btn" id="clearAllTool" data-tool="clear">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>

                <div class="navigation-controls">
                    <button class="nav-btn" id="prevImage">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="imageCounter" class="progress-indicator">1 / 1</span>
                    <button class="nav-btn" id="nextImage">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomOut">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <span id="zoomLevel">100%</span>
                    <button class="zoom-btn" id="zoomIn">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button class="zoom-btn" id="resetZoom">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>

            <!-- Image Info -->
            <div class="image-info">
                <div>
                    <strong>Answer Set ID:</strong> 
                    <span class="anonymous-id" id="currentAnswerSetId">Loading...</span>
                </div>
                <div>
                    <strong>Subject:</strong> 
                    <span id="currentSubject">Loading...</span>
                </div>
            </div>

            <!-- Image Viewer -->
            <div class="image-viewer">
                <div class="image-container" id="imageContainer">
                    <img id="answerImage" class="answer-image" src="" alt="Answer Sheet">
                    <svg id="annotationCanvas" class="annotation-canvas"></svg>
                </div>
            </div>

            <!-- Evaluation Form -->
            <div class="evaluation-form">
                <div class="marks-section">
                    <h3><i class="fas fa-calculator"></i> Total Marks for this Subject</h3>
                    <div class="marks-input">
                        <label for="totalMarks">Total Marks:</label>
                        <input type="number" id="totalMarks" min="0" max="100" step="0.5" placeholder="0">
                        <span>/ <span id="maxMarks">100</span></span>
                    </div>
                </div>

                <div class="comments-section">
                    <h3><i class="fas fa-comment"></i> Comments & Feedback</h3>
                    <textarea id="evaluationComments" placeholder="Enter your comments and feedback for this evaluation..."></textarea>
                </div>

                <div class="submit-section">
                    <button class="save-progress-btn" id="saveProgress">
                        <i class="fas fa-save"></i> Save Progress
                    </button>
                    <button class="submit-btn" id="submitEvaluation">
                        <i class="fas fa-check"></i> Submit Final Evaluation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include required JavaScript files -->
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/backend-init.js"></script>

    <script>
        // Global variables
        let currentUser = null;
        let currentExam = null;
        let eligibleSubjects = [];
        let selectedSubject = null;
        let answerSets = [];
        let selectedAnswerSet = null;
        let currentImageIndex = 0;
        let currentImages = [];
        let annotations = {};
        let currentTool = 'pen';
        let currentColor = '#dc3545';
        let zoomLevel = 1;
        let isDrawing = false;
        let drawingPath = null;

        // Initialize the evaluation page
        async function initializeEvaluationPage() {
            try {
                await window.waitForBackend();
                
                currentUser = await window.backendService.getCurrentUser();
                if (!currentUser) {
                    window.location.href = '../auth/login.html';
                    return;
                }

                // Check if user is an evaluator
                const { data: eligibility, error } = await window.supabaseClient
                    .from('evaluator_eligibility')
                    .select('*')
                    .eq('tutor_id', currentUser.user.id)
                    .eq('enabled', true)
                    .single();

                if (error || !eligibility) {
                    showError('You are not authorized to access the evaluation system. Please contact an administrator.');
                    return;
                }

                eligibleSubjects = eligibility.preferred_subjects || [];
                await loadCurrentExam();
                await loadSubjects();

            } catch (error) {
                console.error('Error initializing evaluation page:', error);
                showError('Failed to initialize evaluation system. Please refresh and try again.');
            }
        }

        // Load current exam
        async function loadCurrentExam() {
            try {
                const { data: exams, error } = await window.supabaseClient
                    .from('icup_exam_metadata')
                    .select('*')
                    .eq('is_archived', false)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (!exams || exams.length === 0) {
                    showError('No active exam found.');
                    return;
                }

                currentExam = exams[0];
            } catch (error) {
                console.error('Error loading current exam:', error);
                showError('Failed to load exam information.');
            }
        }

        // Load eligible subjects
        async function loadSubjects() {
            try {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('subjectSelector').style.display = 'block';

                const subjectGrid = document.getElementById('subjectGrid');
                subjectGrid.innerHTML = '';

                eligibleSubjects.forEach(subject => {
                    const subjectCard = document.createElement('div');
                    subjectCard.className = 'subject-card';
                    subjectCard.dataset.subject = subject;
                    subjectCard.innerHTML = `
                        <h3><i class="fas fa-book"></i> ${subject.charAt(0).toUpperCase() + subject.slice(1)}</h3>
                        <p>Click to evaluate ${subject} papers</p>
                    `;
                    subjectCard.addEventListener('click', () => selectSubject(subject));
                    subjectGrid.appendChild(subjectCard);
                });

            } catch (error) {
                console.error('Error loading subjects:', error);
                showError('Failed to load subjects.');
            }
        }

        // Select subject and load answer sets
        async function selectSubject(subject) {
            try {
                selectedSubject = subject;
                
                // Update UI
                document.querySelectorAll('.subject-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`[data-subject="${subject}"]`).classList.add('selected');

                // Load assigned answer sets for this subject
                await loadAnswerSets();

            } catch (error) {
                console.error('Error selecting subject:', error);
                showError('Failed to load answer sets for selected subject.');
            }
        }

        // Load answer sets assigned to evaluator
        async function loadAnswerSets() {
            try {
                if (!selectedSubject || !currentExam) return;

                // Get evaluator allocation for this subject and exam
                const { data: allocation, error: allocationError } = await window.supabaseClient
                    .from('evaluator_allocation')
                    .select('assigned_answer_sets')
                    .eq('evaluator_id', currentUser.user.id)
                    .eq('exam_id', currentExam.exam_id)
                    .eq('subject', selectedSubject)
                    .single();

                if (allocationError && allocationError.code !== 'PGRST116') {
                    console.error('Allocation error:', allocationError);
                    showError('Error checking answer set assignments: ' + allocationError.message);
                    return;
                }

                if (!allocation || !allocation.assigned_answer_sets || allocation.assigned_answer_sets.length === 0) {
                    // Show empty state instead of error
                    document.getElementById('answerSetSelector').style.display = 'none';
                    document.getElementById('subjectSelector').style.display = 'block';
                    alert('No answer sets have been assigned to you for ' + selectedSubject + ' yet. Please contact your administrator.');
                    return;
                }

                // Get answer sets details
                const { data: sets, error: setsError } = await window.supabaseClient
                    .from('answer_sets')
                    .select('*')
                    .in('id', allocation.assigned_answer_sets);

                if (setsError) {
                    console.error('Sets error:', setsError);
                    throw setsError;
                }

                answerSets = sets || [];
                
                if (answerSets.length === 0) {
                    alert('No valid answer sets found. The assigned answer sets may have been removed.');
                    document.getElementById('answerSetSelector').style.display = 'none';
                    document.getElementById('subjectSelector').style.display = 'block';
                    return;
                }

                await displayAnswerSets();

            } catch (error) {
                console.error('Error loading answer sets:', error);
                showError('Failed to load assigned answer sets: ' + error.message);
            }
        }

        // Display answer sets for selection
        async function displayAnswerSets() {
            try {
                document.getElementById('subjectSelector').style.display = 'none';
                document.getElementById('answerSetSelector').style.display = 'block';

                const answerSetGrid = document.getElementById('answerSetGrid');
                answerSetGrid.innerHTML = '';

                for (const answerSet of answerSets) {
                    // Check if already evaluated
                    const { data: evaluation } = await window.supabaseClient
                        .from('answer_evaluation')
                        .select('*')
                        .eq('answer_set_id', answerSet.id)
                        .eq('subject', selectedSubject)
                        .single();

                    const isEvaluated = evaluation && evaluation.status === 'completed';

                    const answerSetCard = document.createElement('div');
                    answerSetCard.className = `answer-set-card ${isEvaluated ? 'evaluated' : ''}`;
                    answerSetCard.dataset.answerSetId = answerSet.id;
                    
                    const imageCount = answerSet[`${selectedSubject}_images`]?.length || 0;
                    
                    answerSetCard.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h4>Answer Set: ${answerSet.id.substring(0, 8)}...</h4>
                                <p style="color: #666; margin: 0;">Subject: ${selectedSubject}</p>
                                <p style="color: #666; margin: 0; font-size: 0.9rem;">
                                    Images: ${imageCount}
                                </p>
                            </div>
                            <div>
                                ${isEvaluated 
                                    ? '<span style="color: #28a745; font-weight: 600;"><i class="fas fa-check-circle"></i> Evaluated</span>'
                                    : evaluation 
                                        ? '<span style="color: #ffc107; font-weight: 600;"><i class="fas fa-clock"></i> In Progress</span>'
                                        : '<span style="color: #dc3545; font-weight: 600;"><i class="fas fa-exclamation-circle"></i> Pending</span>'
                                }
                            </div>
                        </div>
                    `;

                    if (!isEvaluated) {
                        answerSetCard.addEventListener('click', () => selectAnswerSet(answerSet.id));
                        answerSetCard.style.cursor = 'pointer';
                    } else {
                        answerSetCard.style.opacity = '0.6';
                        answerSetCard.style.cursor = 'not-allowed';
                    }

                    answerSetGrid.appendChild(answerSetCard);
                }

            } catch (error) {
                console.error('Error displaying answer sets:', error);
                showError('Failed to display answer sets.');
            }
        }

        // Select answer set for evaluation
        async function selectAnswerSet(answerSetId) {
            try {
                selectedAnswerSet = answerSets.find(set => set.id === answerSetId);
                if (!selectedAnswerSet) return;

                // Load existing evaluation if any
                const { data: existingEvaluation } = await window.supabaseClient
                    .from('answer_evaluation')
                    .select('*')
                    .eq('answer_set_id', answerSetId)
                    .eq('subject', selectedSubject)
                    .single();

                if (existingEvaluation && existingEvaluation.status === 'completed') {
                    alert('This answer set has already been evaluated and submitted.');
                    return;
                }

                // Load images and annotations
                currentImages = selectedAnswerSet[`${selectedSubject}_images`] || [];
                if (currentImages.length === 0) {
                    alert('No images found for this answer set.');
                    return;
                }

                currentImageIndex = 0;
                annotations = existingEvaluation?.evaluated_pictures || {};

                // Pre-fill form if evaluation in progress
                if (existingEvaluation) {
                    document.getElementById('totalMarks').value = existingEvaluation.total_marks || '';
                    document.getElementById('evaluationComments').value = existingEvaluation.detailed_marks || '';
                }

                // Show evaluation workspace
                document.getElementById('answerSetSelector').style.display = 'none';
                document.getElementById('evaluationWorkspace').style.display = 'block';

                await loadEvaluationWorkspace();

            } catch (error) {
                console.error('Error selecting answer set:', error);
                showError('Failed to load answer set for evaluation.');
            }
        }

        // Load evaluation workspace
        async function loadEvaluationWorkspace() {
            try {
                // Update UI elements
                document.getElementById('currentAnswerSetId').textContent = selectedAnswerSet.id.substring(0, 8) + '...';
                document.getElementById('currentSubject').textContent = selectedSubject;
                
                // Load first image
                await loadImage(0);
                
                // Setup drawing canvas
                setupDrawingCanvas();
                
                // Update navigation
                updateNavigation();

            } catch (error) {
                console.error('Error loading evaluation workspace:', error);
                showError('Failed to setup evaluation workspace.');
            }
        }

        // Load image and annotations
        async function loadImage(index) {
            try {
                if (index < 0 || index >= currentImages.length) return;

                currentImageIndex = index;
                const imageUrl = currentImages[index];

                const img = document.getElementById('answerImage');
                img.onload = function() {
                    // Reset zoom
                    zoomLevel = 1;
                    updateZoom();
                    
                    // Load annotations for this image
                    loadAnnotationsForImage(index);
                };
                
                img.src = imageUrl;
                updateNavigation();

            } catch (error) {
                console.error('Error loading image:', error);
                showError('Failed to load image.');
            }
        }

        // Setup drawing canvas
        function setupDrawingCanvas() {
            const canvas = document.getElementById('annotationCanvas');
            const imageContainer = document.getElementById('imageContainer');

            // Resize canvas to match image container
            function resizeCanvas() {
                const rect = imageContainer.getBoundingClientRect();
                canvas.setAttribute('width', rect.width);
                canvas.setAttribute('height', rect.height);
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
            }

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Drawing event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        // Drawing functions
        function startDrawing(e) {
            if (currentTool === 'pen') {
                isDrawing = true;
                const rect = e.target.getBoundingClientRect();
                const x = (e.clientX - rect.left) / zoomLevel;
                const y = (e.clientY - rect.top) / zoomLevel;
                
                drawingPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                drawingPath.setAttribute('stroke', currentColor);
                drawingPath.setAttribute('stroke-width', '2');
                drawingPath.setAttribute('fill', 'none');
                drawingPath.setAttribute('d', `M${x},${y}`);
                
                document.getElementById('annotationCanvas').appendChild(drawingPath);
            }
        }

        function draw(e) {
            if (!isDrawing || currentTool !== 'pen') return;
            
            const rect = e.target.getBoundingClientRect();
            const x = (e.clientX - rect.left) / zoomLevel;
            const y = (e.clientY - rect.top) / zoomLevel;
            
            const currentPath = drawingPath.getAttribute('d');
            drawingPath.setAttribute('d', currentPath + ` L${x},${y}`);
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                if (drawingPath) {
                    saveAnnotation();
                    drawingPath = null;
                }
            }
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            e.target.dispatchEvent(mouseEvent);
        }

        // Save annotation to memory
        function saveAnnotation() {
            const imageKey = `image_${currentImageIndex}`;
            if (!annotations[imageKey]) {
                annotations[imageKey] = [];
            }
            
            const annotationData = {
                type: 'path',
                data: drawingPath.getAttribute('d'),
                color: drawingPath.getAttribute('stroke'),
                strokeWidth: drawingPath.getAttribute('stroke-width'),
                timestamp: new Date().toISOString()
            };
            
            annotations[imageKey].push(annotationData);
        }

        // Load annotations for current image
        function loadAnnotationsForImage(index) {
            const canvas = document.getElementById('annotationCanvas');
            
            // Clear existing annotations
            while (canvas.firstChild) {
                canvas.removeChild(canvas.firstChild);
            }
            
            const imageKey = `image_${index}`;
            const imageAnnotations = annotations[imageKey] || [];
            
            imageAnnotations.forEach(annotation => {
                if (annotation.type === 'path') {
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('stroke', annotation.color);
                    path.setAttribute('stroke-width', annotation.strokeWidth);
                    path.setAttribute('fill', 'none');
                    path.setAttribute('d', annotation.data);
                    canvas.appendChild(path);
                }
            });
        }

        // Tool functions
        function selectTool(tool) {
            currentTool = tool;
            
            // Update UI
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
            
            // Update cursor
            const canvas = document.getElementById('annotationCanvas');
            if (tool === 'pen') {
                canvas.style.cursor = 'crosshair';
            } else if (tool === 'eraser') {
                canvas.style.cursor = 'grab';
            }
        }

        function selectColor(color) {
            currentColor = color;
            
            // Update UI
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-color="${color}"]`).classList.add('active');
        }

        function clearAllAnnotations() {
            if (confirm('Are you sure you want to clear all annotations for this image?')) {
                const canvas = document.getElementById('annotationCanvas');
                while (canvas.firstChild) {
                    canvas.removeChild(canvas.firstChild);
                }
                
                const imageKey = `image_${currentImageIndex}`;
                annotations[imageKey] = [];
            }
        }

        // Navigation functions
        function navigateImage(direction) {
            const newIndex = currentImageIndex + direction;
            if (newIndex >= 0 && newIndex < currentImages.length) {
                loadImage(newIndex);
            }
        }

        function updateNavigation() {
            document.getElementById('imageCounter').textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
            document.getElementById('prevImage').disabled = currentImageIndex === 0;
            document.getElementById('nextImage').disabled = currentImageIndex === currentImages.length - 1;
        }

        // Zoom functions
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel * 1.2, 3);
            updateZoom();
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel / 1.2, 0.5);
            updateZoom();
        }

        function resetZoom() {
            zoomLevel = 1;
            updateZoom();
        }

        function updateZoom() {
            const img = document.getElementById('answerImage');
            const canvas = document.getElementById('annotationCanvas');
            
            img.style.transform = `scale(${zoomLevel})`;
            canvas.style.transform = `scale(${zoomLevel})`;
            
            document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
        }

        // Save progress
        async function saveProgress() {
            try {
                const totalMarks = parseFloat(document.getElementById('totalMarks').value) || 0;
                const comments = document.getElementById('evaluationComments').value;

                const evaluationData = {
                    answer_set_id: selectedAnswerSet.id,
                    subject: selectedSubject,
                    total_marks: totalMarks,
                    detailed_marks: comments,
                    evaluated_pictures: annotations,
                    status: 'in_progress',
                    updated_at: new Date().toISOString()
                };

                const { error } = await window.supabaseClient
                    .from('answer_evaluation')
                    .upsert(evaluationData);

                if (error) throw error;

                alert('Progress saved successfully!');

            } catch (error) {
                console.error('Error saving progress:', error);
                alert('Failed to save progress. Please try again.');
            }
        }

        // Submit final evaluation
        async function submitEvaluation() {
            try {
                const totalMarks = parseFloat(document.getElementById('totalMarks').value);
                const comments = document.getElementById('evaluationComments').value;

                if (isNaN(totalMarks) || totalMarks < 0) {
                    alert('Please enter a valid total marks.');
                    return;
                }

                if (!confirm('Are you sure you want to submit this evaluation? You cannot modify it after submission.')) {
                    return;
                }

                const evaluationData = {
                    answer_set_id: selectedAnswerSet.id,
                    subject: selectedSubject,
                    total_marks: totalMarks,
                    detailed_marks: comments,
                    evaluated_pictures: annotations,
                    status: 'completed',
                    submitted_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                const { error } = await window.supabaseClient
                    .from('answer_evaluation')
                    .upsert(evaluationData);

                if (error) throw error;

                alert('Evaluation submitted successfully!');
                
                // Return to answer set selection
                document.getElementById('evaluationWorkspace').style.display = 'none';
                await displayAnswerSets();

            } catch (error) {
                console.error('Error submitting evaluation:', error);
                alert('Failed to submit evaluation. Please try again.');
            }
        }

        // Error handling
        function showError(message) {
            document.getElementById('loadingState').innerHTML = `
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
                <h3>Error</h3>
                <p>${message}</p>
                <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    Try Again
                </button>
            `;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Tool selection
            document.getElementById('penTool').addEventListener('click', () => selectTool('pen'));
            document.getElementById('eraserTool').addEventListener('click', () => selectTool('eraser'));
            document.getElementById('clearAllTool').addEventListener('click', clearAllAnnotations);

            // Color selection
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', (e) => selectColor(e.target.dataset.color));
            });

            // Navigation
            document.getElementById('prevImage').addEventListener('click', () => navigateImage(-1));
            document.getElementById('nextImage').addEventListener('click', () => navigateImage(1));

            // Zoom controls
            document.getElementById('zoomIn').addEventListener('click', zoomIn);
            document.getElementById('zoomOut').addEventListener('click', zoomOut);
            document.getElementById('resetZoom').addEventListener('click', resetZoom);

            // Form actions
            document.getElementById('saveProgress').addEventListener('click', saveProgress);
            document.getElementById('submitEvaluation').addEventListener('click', submitEvaluation);

            // Initialize
            initializeEvaluationPage();
        });
    </script>
</body>
</html>
